
ğŸ˜­ğŸ˜”<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ - CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/theme-unified.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #E8F5E8 0%, #D4F1D4 100%);
            --accent-color: #B8E6B8;
            --text-color: #2C3E50;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body {
            background: var(--primary-gradient);
            font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            color: var(--text-color);
            min-height: 100vh;
        }

        .glassmorphism {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 18px rgba(0,0,0,0.15); 
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 16px;
            font-weight: 500;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-secondary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        }

        .btn-secondary.active {
            background: linear-gradient(135deg, #FF5722, #E64A19);
            transform: translateY(-1px);
        }

        .ce-area {
            background: rgba(255,255,255,0.85);
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--shadow);
            border-left: 4px solid #3b82f6;
            margin-bottom: 20px;
            break-inside: avoid;
        }

        .timeline-day-row {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.06);
            transition: background-color 0.3s ease;
        }

        .timeline-track {
            position: relative;
            width: 100%;
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #ddd;
            min-height: 30px;
        }

        .task-bar {
            position: absolute;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-bar:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .time-scale {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            padding: 0 4px;
            font-size: 10px;
            color: #666;
        }

        .filter-section {
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .no-tasks-message {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
            border: 2px dashed #ddd;
            grid-column: 1 / -1;
        }

        .auth-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
            margin: 20px;
            color: #991b1b;
        }

        .ce-filter-grid {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }

        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            margin-left: 4px;
            margin-right: 4px;
        }

        .period-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .custom-period {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }

        .custom-period.active {
            display: grid;
        }

        /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            body { 
                background: white !important; 
                color: #000 !important; 
            }
            .no-print { 
                display: none !important; 
            }
            .glassmorphism { 
                background: white !important; 
                border: 1px solid #ccc !important; 
            }
            .ce-area {
                break-inside: avoid;
                margin-bottom: 15px;
            }
            #timelineContainer {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 15px !important;
            }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .filter-section {
                padding: 12px;
            }
            
            .ce-area {
                padding: 12px;
            }
            
            .timeline-day-row {
                padding: 8px;
            }
            
            .task-bar {
                font-size: 10px;
                height: 20px;
            }
            
            .time-scale {
                font-size: 9px;
            }

            .ce-filter-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .period-buttons {
                gap: 4px;
            }

            .btn-secondary {
                padding: 6px 12px;
                font-size: 12px;
            }

            .custom-period {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="authWarning" class="auth-error" style="display: none;">
        <h3><i class="fas fa-exclamation-triangle mr-2"></i>èªè¨¼ã‚¨ãƒ©ãƒ¼</h3>
        <p>ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ã€ã¾ãš<a href="../pages/home.html" class="underline font-bold">ãƒ›ãƒ¼ãƒ </a>ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
        <p class="text-sm mt-2">ã¾ãŸã¯ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã€Œé›†è¨ˆãƒ»åˆ†æã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 no-print">
            <div>
                <h1 class="text-3xl font-bold mb-2">
                    <i class="fas fa-user-clock mr-3 text-blue-600"></i>å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
                </h1>
                <p class="text-gray-600">CEå€‹äººã”ã¨ã®æ¥­å‹™ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨å‹¤å‹™çŠ¶æ…‹ã‚’æ™‚é–“è»¸ã§å¯è¦–åŒ–</p>
            </div>
            <div class="flex gap-3 mt-4 md:mt-0">
                <button onclick="window.print()" class="btn-primary">
                    <i class="fas fa-print mr-2"></i>å°åˆ·
                </button>
                <button onclick="window.location.href='../pages/analytics.html'" 
                        class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-gray-700 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>é›†è¨ˆãƒ»åˆ†æã«æˆ»ã‚‹
                </button>
            </div>
        </div>

        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="filter-section no-print">
            <h3 class="text-lg font-bold mb-4">
                <i class="fas fa-filter mr-2"></i>è¡¨ç¤ºè¨­å®š
            </h3>
            
            <!-- æœŸé–“è¨­å®šï¼ˆæ¥­å‹™åˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¨çµ±ä¸€ï¼‰ -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">é›†è¨ˆæœŸé–“</label>
                <div class="period-buttons">
                    <button id="todayBtn" class="btn-secondary">
                        <i class="fas fa-calendar-day mr-1"></i>ä»Šæ—¥
                    </button>
                    <button id="thisWeekBtn" class="btn-secondary active">
                        <i class="fas fa-calendar-week mr-1"></i>ä»Šé€±
                    </button>
                    <button id="thisMonthBtn" class="btn-secondary">
                        <i class="fas fa-calendar-alt mr-1"></i>ä»Šæœˆ
                    </button>
                    <button id="customPeriodBtn" class="btn-secondary">
                        <i class="fas fa-calendar mr-1"></i>ã‚«ã‚¹ã‚¿ãƒ æœŸé–“
                    </button>
                </div>
                
                <!-- ã‚«ã‚¹ã‚¿ãƒ æœŸé–“è¨­å®š -->
                <div id="customPeriodSection" class="custom-period">
                    <div>
                        <label class="block text-sm font-medium mb-2">é–‹å§‹æ—¥</label>
                        <input type="date" id="startDate" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">çµ‚äº†æ—¥</label>
                        <input type="date" id="endDate" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                </div>
            </div>

            <!-- æ™‚é–“ç¯„å›²è¨­å®š -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">è¡¨ç¤ºé–‹å§‹æ™‚åˆ»</label>
                    <input type="time" id="displayStartTime" value="07:00" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">è¡¨ç¤ºçµ‚äº†æ™‚åˆ»</label>
                    <input type="time" id="displayEndTime" value="19:00" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>

                <!-- ç©ºç™½ã®ã‚¹ãƒšãƒ¼ã‚¹ -->
                <div></div>
                <div></div>
            </div>

            <!-- CEãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨éƒ¨é–€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">è¡¨ç¤ºCEï¼ˆå‹¤å‹™è¡¨å…¨å“¡: <span id="totalCECount">--</span>åï¼‰</label>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="selectAllCEs" checked>
                            <span class="ml-2 font-bold">å…¨CEé¸æŠ</span>
                        </label>
                    </div>
                    <div id="ceFilterContainer" class="max-h-32 overflow-y-auto grid gap-1 ce-filter-grid">
                        <!-- CEãƒªã‚¹ãƒˆã¯å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">è¡¨ç¤ºéƒ¨é–€</label>
                    <div class="flex flex-wrap gap-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="all" checked>
                            <span class="ml-2 font-bold">å…¨éƒ¨é–€</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="è¡€æ¶²æµ„åŒ–" checked>
                            <span class="ml-2">è¡€æ¶²æµ„åŒ–</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°" checked>
                            <span class="ml-2">äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«" checked>
                            <span class="ml-2">å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="æ‰‹è¡“ãƒ»éº»é…”" checked>
                            <span class="ml-2">æ‰‹è¡“ãƒ»éº»é…”</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="ä¸æ•´è„ˆ" checked>
                            <span class="ml-2">ä¸æ•´è„ˆ</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸" checked>
                            <span class="ml-2">æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="department-filter" value="ä¼šè­°ãƒ»ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»å‹‰å¼·ä¼šãƒ»æ‰“ã¡åˆã‚ã›" checked>
                            <span class="ml-2">ä¼šè­°ãƒ»å‹‰å¼·ä¼š</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button id="applyFiltersBtn" class="btn-primary">
                    <i class="fas fa-search mr-2"></i>è¡¨ç¤ºæ›´æ–°
                </button>
                <button id="resetFiltersBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    <i class="fas fa-undo mr-2"></i>ãƒªã‚»ãƒƒãƒˆ
                </button>
                <button id="currentWeekBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                    <i class="fas fa-calendar-week mr-2"></i>ä»Šé€±è¡¨ç¤º
                </button>
            </div>
        </div>

        <!-- V1ç‰ˆæº–æ‹ ã®å€‹äººåˆ¥æ¥­å‹™æ™‚é–“ã‚°ãƒ©ãƒ• -->
        <div class="glassmorphism rounded-2xl p-6 mb-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-bold">
                    <i class="fas fa-chart-bar mr-2"></i>å€‹äººåˆ¥æ¥­å‹™æ™‚é–“ï¼ˆæ™‚é–“ï¼‰- V1ç‰ˆæº–æ‹ 
                </h3>
                <button class="btn-primary text-sm" onclick="printCanvas('individualChart')">
                    <i class="fas fa-print mr-1"></i>å°åˆ·
                </button>
            </div>
            <div class="text-xs text-gray-600 mb-3">
                åŒä¸€æ™‚é–“å¸¯ã®è¤‡æ•°æ¥­å‹™ã¯é‡è¤‡ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã›ã‚“ã€‚å®Ÿéš›ã®åŠ´åƒæ™‚é–“ã«åŸºã¥ãé›†è¨ˆã§ã™ã€‚
            </div>
            <div class="h-96">
                <canvas id="individualChart"></canvas>
            </div>
        </div>

        <!-- ã‚µãƒãƒªãƒ¼æƒ…å ± -->
        <div id="summarySection" class="glassmorphism rounded-2xl p-4 mb-6">
            <h3 class="text-lg font-bold mb-3">
                <i class="fas fa-info-circle mr-2"></i>è¡¨ç¤ºã‚µãƒãƒªãƒ¼
            </h3>
            <div id="summaryContent" class="grid grid-cols-1 md:grid-cols-5 gap-4 text-sm">
                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆ3åˆ—ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ -->
        <div id="timelineContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div id="loadingIndicator" class="text-center py-8" style="display: none;">
            <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
            <p class="mt-2 text-gray-600">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="../js/config/firebase-config.js"></script>
    <script src="../js/core/auth-guard.js"></script>

    <!-- ç›£æŸ»ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="../js/utils/audit-logger.js"></script>

    <script>
        // èªè¨¼ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
        function checkAuthenticationStatus() {
            let targetUID = sessionStorage.getItem('targetUID');
            let currentUsername = sessionStorage.getItem('currentUsername');

            if (!targetUID || !currentUsername) {
                const params = new URLSearchParams(location.search);
                const qpUid = params.get('uid');
                const qpUsername = params.get('username') || params.get('user');
                const qpRole = params.get('role');

                if (qpUid && qpUsername) {
                    targetUID = qpUid;
                    currentUsername = qpUsername;
                    try {
                        sessionStorage.setItem('targetUID', qpUid);
                        sessionStorage.setItem('currentUsername', qpUsername);
                        sessionStorage.setItem('currentUser', qpUsername);
                        if (qpRole) sessionStorage.setItem('userRole', qpRole);
                        console.log('âœ… URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å¾©å…ƒ');
                    } catch (e) {
                        console.warn('sessionStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                    }
                }
            }

            if (!targetUID || !currentUsername) {
                console.warn('âš ï¸ èªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
                document.getElementById('authWarning').style.display = 'block';
                return false;
            }

            console.log('âœ… èªè¨¼æƒ…å ±ç¢ºèªå®Œäº†');
            document.getElementById('authWarning').style.display = 'none';
            return true;
        }

        // V2ç‰ˆFirebaseè¨­å®šï¼ˆdashboard.htmlã¨çµ±ä¸€ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyCRUvvs0OSz_9L9bXtqteVFIIze1OaZObE",
            authDomain: "ce-scheduling-system-v2.firebaseapp.com",
            databaseURL: "https://ce-scheduling-system-v2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ce-scheduling-system-v2",
            storageBucket: "ce-scheduling-system-v2.firebasestorage.app",
            messagingSenderId: "288279598010",
            appId: "1:288279598010:web:d545ee1d4d854513084383",
            measurementId: "G-LSEEMJE2R0"
        };

        const DATA_ROOT = 'ceScheduleV2';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let database = null;
        let authReadyPromise = null;
        let v2EventsByDate = {};
        let globalCEList = [];
        let globalWorkStatusData = {}; // CE ID -> dateISO -> status
        let currentDateRange = [];
        let displayStartHour = 7;
        let displayEndHour = 19;
        let chartInstances = {};
        let currentPeriodType = 'thisWeek';

        // ç„¡åŠ¹ãƒ‡ãƒ¼ã‚¿é™¤å¤–ãƒªã‚¹ãƒˆ
        const CE_DENY_NAMES = new Set(['list', 'updatedAt', 'lastUpdated', 'timestamp', 'ceList', 'state', 'templates', 'metadata', 'default', 'scheduleData', 'workTypeOverrides']);

        // éƒ¨é–€è¨­å®š
        const DEPARTMENTS = [
            'è¡€æ¶²æµ„åŒ–', 'äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°', 'å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«', 
            'æ‰‹è¡“ãƒ»éº»é…”', 'ä¸æ•´è„ˆ', 'æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸',
            'ä¼šè­°ãƒ»ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»å‹‰å¼·ä¼šãƒ»æ‰“ã¡åˆã‚ã›'
        ];

        const DEPARTMENT_COLORS = {
            'è¡€æ¶²æµ„åŒ–': '#FFB6C1',
            'äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°': '#4169E1',
            'å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«': '#32CD32',
            'æ‰‹è¡“ãƒ»éº»é…”': '#87CEEB',
            'ä¸æ•´è„ˆ': '#9370DB',
            'æ©Ÿå™¨ç®¡ç†ãƒ»äººå·¥å‘¼å¸': '#90EE90',
            'ä¼šè­°ãƒ»ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»å‹‰å¼·ä¼šãƒ»æ‰“ã¡åˆã‚ã›': '#9E9E9E'
        };

        // å‹¤å‹™çŠ¶æ…‹å®šç¾©
        const WORK_STATUS_DEFINITIONS = {
            'A': { label: 'A', color: '#4CAF50' },
            'A1': { label: 'A1', color: '#FF9800' },
            'B': { label: 'B', color: '#9C27B0' },
            'é': { label: 'éç•ª', color: '#607D8B' },
            'Ã—': { label: 'ä¼‘ã¿', color: '#F44336' },
            'å¹´': { label: 'å¹´ä¼‘', color: '#2196F3' },
            'å‡º': { label: 'å‡ºå¼µ', color: '#2196F3' },
            'ç ”': { label: 'ç ”ä¿®', color: '#795548' }
        };

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: 16é€²æ•°ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’RGBAã«å¤‰æ›
        function hexToRgba(hex, alpha = 1) {
            if (!hex || hex.length < 7) return `rgba(0,0,0,${alpha})`;
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // ========== æœŸé–“è¨­å®šæ©Ÿèƒ½ ==========
        function setPeriod(type) {
            currentPeriodType = type;
            updatePeriodButtons();
            
            const today = new Date();
            let startDate, endDate;
            
            switch (type) {
                case 'today':
                    startDate = endDate = new Date(today);
                    break;
                    
                case 'thisWeek':
                    const dayFromMonday = (today.getDay() + 6) % 7; // æœˆæ›œæ—¥ã‚’èµ·ç‚¹ã¨ã—ãŸè¨ˆç®—
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - dayFromMonday);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                    
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                    
                case 'custom':
                    document.getElementById('customPeriodSection').classList.add('active');
                    return; // ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ã¯æ‰‹å‹•è¨­å®šã®ãŸã‚ã€ã“ã“ã§ã¯æ—¥ä»˜è¨­å®šã—ãªã„
                    
                default:
                    return;
            }
            
            // ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ä»¥å¤–ã¯è‡ªå‹•ã§æ—¥ä»˜è¨­å®š
            if (type !== 'custom') {
                document.getElementById('customPeriodSection').classList.remove('active');
                document.getElementById('startDate').value = formatDateForInput(startDate);
                document.getElementById('endDate').value = formatDateForInput(endDate);
                
                // è‡ªå‹•å®Ÿè¡Œ
                loadTimelineData();
            }
        }

        function updatePeriodButtons() {
            document.querySelectorAll('.btn-secondary').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = {
                'today': 'todayBtn',
                'thisWeek': 'thisWeekBtn', 
                'thisMonth': 'thisMonthBtn',
                'custom': 'customPeriodBtn'
            }[currentPeriodType];
            
            if (activeBtn) {
                document.getElementById(activeBtn).classList.add('active');
            }
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ä»Šé€±è¡¨ç¤ºæ©Ÿèƒ½ï¼ˆdepartment-timeline.htmlã¨çµ±ä¸€ï¼‰
        function setCurrentWeekRange() {
            const today = new Date();
            const dayFromMonday = (today.getDay() + 6) % 7;

            const startDate = new Date(today);
            startDate.setHours(0, 0, 0, 0);
            startDate.setDate(today.getDate() - dayFromMonday);

            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setHours(0, 0, 0, 0);

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];

            console.log(`ğŸ“… ä»Šé€±è¨­å®š: ${startDate.toISOString().split('T')[0]} ï½ ${endDate.toISOString().split('T')[0]}`);
        }

        function setCurrentWeekAndLoad() {
            setCurrentWeekRange();
            loadTimelineData();
        }

        // ========== å‹¤å‹™è¡¨ã‹ã‚‰ã®CEãƒªã‚¹ãƒˆå–å¾— ==========
        async function loadLatestWorkSchedule() {
            try {
                const snapshot = await database.ref(`${DATA_ROOT}/workSchedules`).once('value');
                const data = snapshot.val() || {};
                
                const schedules = Object.keys(data)
                    .map(key => ({ key, ...data[key] }))
                    .filter(s => s.metadata && s.metadata.isVisible !== false);
                
                if (schedules.length === 0) return null;
                
                schedules.sort((a, b) => (b.metadata?.publishedAt || 0) - (a.metadata?.publishedAt || 0));
                return schedules[0]; // æœ€æ–°ã®å…¬é–‹å‹¤å‹™è¡¨
            } catch (error) {
                console.error('âŒ å‹¤å‹™è¡¨èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        function buildCEListFromWorkSchedule(schedule) {
            if (!schedule || !schedule.ceList || !Array.isArray(schedule.ceList)) {
                return [];
            }
            
            return schedule.ceList
                .filter(ce => ce && typeof ce === 'object')
                .filter(ce => {
                    const id = ce.id || '';
                    const name = ce.fullName || ce.name || '';
                    return !CE_DENY_NAMES.has(id) && !CE_DENY_NAMES.has(name) && name.trim() !== '';
                })
                .map(ce => ({
                    id: ce.id,
                    name: ce.fullName || ce.name, // fullNameï¼ˆæ°åï¼‰ã‚’æœ€å„ªå…ˆ
                    fullName: ce.fullName || ce.name,
                    iconName: ce.iconName || ce.displayName,
                    workType: ce.workType || 'ME'
                }));
        }

        function buildWorkStatusMap(schedule, ceList, dateRange) {
            const statusMap = {};
            
            if (!schedule || !schedule.scheduleData) {
                return statusMap;
            }
            
            const scheduleData = schedule.scheduleData;
            
            dateRange.forEach(date => {
                const dateKey = formatDateAsISO(date);
                
                ceList.forEach(ce => {
                    const workData = scheduleData[ce.id]?.[dateKey];
                    const status = workData ? (workData.customText?.trim() || workData.status || '') : '';
                    
                    if (!statusMap[ce.id]) statusMap[ce.id] = {};
                    statusMap[ce.id][dateKey] = status;
                });
            });
            
            return statusMap;
        }

        // V1ç‰ˆæº–æ‹ ã®é‡è¤‡é™¤å¤–è¨ˆç®—
        function collectMinuteMapV1Style(filteredCEs, selectedDepartments, eventsByDate) {
            const ceIds = new Set(filteredCEs.map(c => c.id));
            const minuteMap = new Map();

            currentDateRange.forEach(date => {
                const dateKey = formatDateAsISO(date);
                const dayEvents = eventsByDate[dateKey] || {};

                Object.values(dayEvents).forEach(event => {
                    if (selectedDepartments.length && !selectedDepartments.includes(event.department)) return;
                    if (!event.startTime || !event.endTime) return;

                    const startMinutes = timeToMinutes(event.startTime);
                    const endMinutes = timeToMinutes(event.endTime);
                    if (!(Number.isFinite(startMinutes) && Number.isFinite(endMinutes)) || endMinutes <= startMinutes) return;

                    const assignedCEs = event.assignedCEs || [];
                    if (!assignedCEs.length) return;

                    assignedCEs.forEach(assigned => {
                        let ceId = '';
                        if (typeof assigned === 'string') {
                            ceId = assigned;
                        } else if (assigned && typeof assigned === 'object') {
                            ceId = assigned.id || assigned.name || '';
                        }
                        
                        if (!ceId || !ceIds.has(ceId)) return;

                        if (!minuteMap.has(ceId)) minuteMap.set(ceId, new Map());
                        const byDate = minuteMap.get(ceId);
                        if (!byDate.has(dateKey)) byDate.set(dateKey, new Set());
                        const minuteSet = byDate.get(dateKey);

                        for (let minute = startMinutes; minute < endMinutes; minute++) {
                            minuteSet.add(minute);
                        }
                    });
                });
            });

            return minuteMap;
        }

        function computeTotalHoursV1Style(minuteMap, filteredCEs) {
            const totalHoursByCE = [];

            filteredCEs.forEach(ce => {
                const dayMap = minuteMap.get(ce.id) || new Map();
                let uniqueMinutes = 0;
                const daySchedules = {};

                currentDateRange.forEach(date => {
                    const dateKey = formatDateAsISO(date);
                    const minuteSet = dayMap.get(dateKey) || new Set();
                    
                    daySchedules[dateKey] = minuteSet.size;
                    uniqueMinutes += minuteSet.size;
                });

                const totalHours = Math.round((uniqueMinutes / 60) * 10) / 10;
                totalHoursByCE.push({ 
                    id: ce.id,
                    name: ce.name,
                    hours: totalHours,
                    daySchedules: daySchedules
                });
            });

            totalHoursByCE.sort((a, b) => b.hours - a.hours);
            return totalHoursByCE;
        }

        // ========== åˆæœŸåŒ– ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ”„ å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³åˆæœŸåŒ–é–‹å§‹');
            
            if (!checkAuthenticationStatus()) return;
            
            initializeFirebase();
            setupEventListeners();
            
            // åˆæœŸè¡¨ç¤ºã¯ä»Šé€±ã«è¨­å®šï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰
            console.log('ğŸ”„ ä»Šé€±ã®ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•è¨­å®šãƒ»èª­ã¿è¾¼ã¿é–‹å§‹');
            setPeriod('thisWeek');
            
            try {
                if (authReadyPromise) {
                    await authReadyPromise;
                } else {
                    let authUser = firebase.auth().currentUser;
                    let attempts = 0;
                    
                    while (!authUser && attempts < 30) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        authUser = firebase.auth().currentUser;
                        attempts++;
                    }
                    
                    if (!authUser) {
                        throw new Error('Firebaseèªè¨¼ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                    }
                }
                
                console.log('âœ… å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³åˆæœŸåŒ–å®Œäº†ï¼ˆä»Šé€±ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºæ¸ˆã¿ï¼‰');
                
            } catch (error) {
                console.error('âŒ åˆæœŸèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showMessage(`ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        });

        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();

                authReadyPromise = new Promise((resolve, reject) => {
                    firebase.auth().onAuthStateChanged(user => {
                        if (user) {
                            console.log('âœ… Firebaseèªè¨¼å®Œäº†:', user.uid);
                            resolve(user);
                        }
                    }, err => {
                        console.error('âŒ Firebaseèªè¨¼ã‚¨ãƒ©ãƒ¼:', err);
                        reject(err);
                    });
                });

                firebase.auth().signInAnonymously().catch((error) => {
                    console.error('âŒ FirebaseåŒ¿åèªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                    document.getElementById('authWarning').style.display = 'block';
                });
                    
            } catch (error) {
                console.error('âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('authWarning').style.display = 'block';
            }
        }

        function setupEventListeners() {
            // æœŸé–“è¨­å®šãƒœã‚¿ãƒ³ï¼ˆæ¥­å‹™åˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¨çµ±ä¸€ï¼‰
            document.getElementById('todayBtn').addEventListener('click', () => setPeriod('today'));
            document.getElementById('thisWeekBtn').addEventListener('click', () => setPeriod('thisWeek'));
            document.getElementById('thisMonthBtn').addEventListener('click', () => setPeriod('thisMonth'));
            document.getElementById('customPeriodBtn').addEventListener('click', () => setPeriod('custom'));
            
            // ãã®ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('applyFiltersBtn').addEventListener('click', loadTimelineData);
            document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
            document.getElementById('currentWeekBtn').addEventListener('click', setCurrentWeekAndLoad);
            
            setTimeout(() => {
                const allDeptCheckbox = document.querySelector('.department-filter[value="all"]');
                if (allDeptCheckbox) {
                    allDeptCheckbox.addEventListener('change', function() {
                        const isChecked = this.checked;
                        document.querySelectorAll('.department-filter:not([value="all"])').forEach(cb => {
                            cb.checked = isChecked;
                        });
                        regenerateViews(); // å³æ™‚æ›´æ–°è¿½åŠ 
                    });
                }
                
                document.querySelectorAll('.department-filter:not([value="all"])').forEach(cb => {
                    cb.addEventListener('change', () => {
                        updateAllDepartmentCheckbox();
                        regenerateViews(); // å³æ™‚æ›´æ–°è¿½åŠ 
                    });
                });
            }, 100);
        }

        // ========== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ==========
        async function loadTimelineData() {
            showLoading(true);
            console.log('ğŸ”„ å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿é–‹å§‹');
            
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    showMessage('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                currentDateRange = generateDateRange(startDate, endDate);
                
                await loadDataFromFirebase();
                updateDisplayTimeRange();
                generateCEFilterList();
                generateIndividualChart();
                generateTimeline();
                updateSummary();
                
                console.log('âœ… å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿å®Œäº†');
                
            } catch (error) {
                console.error('âŒ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                // CEãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç¢ºå®Ÿç”Ÿæˆ
                setTimeout(() => {
                    generateCEFilterList();
                    updateSummary();
                }, 200);
                showLoading(false);
            }
        }

        async function loadDataFromFirebase() {
            if (!database) throw new Error('Firebaseæœªæ¥ç¶š');
            
            try {
                console.log('ğŸ”„ Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
                
                const [eventsByDateSnapshot, latestSchedule] = await Promise.all([
                    database.ref(`${DATA_ROOT}/events/byDate`).once('value'),
                    loadLatestWorkSchedule()
                ]);
                
                v2EventsByDate = eventsByDateSnapshot.val() || {};
                console.log('ğŸ“Š ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿:', Object.keys(v2EventsByDate).length, 'æ—¥åˆ†');
                
                if (latestSchedule && latestSchedule.ceList) {
                    globalCEList = buildCEListFromWorkSchedule(latestSchedule);
                    globalWorkStatusData = buildWorkStatusMap(latestSchedule, globalCEList, currentDateRange);
                    console.log('âœ… å‹¤å‹™è¡¨ã‹ã‚‰CEå–å¾—:', globalCEList.length, 'å');
                } else {
                    console.warn('âš ï¸ å…¬é–‹å‹¤å‹™è¡¨æœªç™ºè¦‹ - CEãƒªã‚¹ãƒˆã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èª­ã¿è¾¼ã¿');
                    await loadCEListFallback();
                }
                
                console.log('âœ… Firebaseãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº† - CEæ•°:', globalCEList.length);
                
            } catch (error) {
                console.error('âŒ Firebaseèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨CEèª­ã¿è¾¼ã¿é–¢æ•°
        async function loadCEListFallback() {
            try {
                const ceListSnapshot = await database.ref(`${DATA_ROOT}/ceList`).once('value');
                const ceListData = ceListSnapshot.val();
                
                if (ceListData && ceListData.list && Array.isArray(ceListData.list)) {
                    globalCEList = ceListData.list
                        .filter(ce => ce && ce.id && (ce.fullName || ce.iconName || ce.name))
                        .map(ce => ({
                            id: ce.id,
                            name: ce.fullName || ce.iconName || ce.displayName || ce.name,
                            fullName: ce.fullName || ce.iconName || ce.displayName || ce.name,
                            iconName: ce.iconName || ce.displayName || ce.name,
                            workType: ce.workType || 'ME'
                        }));
                    console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: CEãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº†:', globalCEList.length, 'å');
                } else {
                    globalCEList = [];
                    console.error('âŒ CEãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                globalWorkStatusData = {}; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã¯å‹¤å‹™çŠ¶æ…‹ãªã—
            } catch (error) {
                console.error('âŒ CEãƒªã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                globalCEList = [];
                globalWorkStatusData = {};
            }
        }

        function generateDateRange(startDateStr, endDateStr) {
            const dates = [];
            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');
            
            const current = new Date(startDate);
            
            while (current <= endDate) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            
            return dates;
        }

        function updateDisplayTimeRange() {
            const startTime = document.getElementById('displayStartTime').value;
            const endTime = document.getElementById('displayEndTime').value;
            
            displayStartHour = parseInt(startTime.split(':')[0]);
            displayEndHour = parseInt(endTime.split(':')[0]);
        }

        function generateCEFilterList() {
            const container = document.getElementById('ceFilterContainer');
            const countEl = document.getElementById('totalCECount');
            if (!container) return;

            console.log('ğŸ”„ CEãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”Ÿæˆ:', { globalCEList: globalCEList.length });

            // æ—¢å­˜é¸æŠã‚’ä¿æŒ
            const preselected = new Set(
                Array.from(container.querySelectorAll('.ce-filter:checked')).map(cb => cb.value)
            );

            container.innerHTML = '';
            if (countEl) countEl.textContent = globalCEList.length;

            if (globalCEList.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-xs p-2">CEãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
                return;
            }

            globalCEList.forEach(ce => {
                const label = document.createElement('label');
                label.className = 'flex items-center text-sm';
                label.title = ce.fullName || ce.name;
                const shouldCheck = preselected.size > 0 ? preselected.has(ce.id) : true;
                label.innerHTML = `
                    <input type="checkbox" class="ce-filter" value="${ce.id}" ${shouldCheck ? 'checked' : ''}>
                    <span class="ml-1 truncate">${ce.fullName || ce.name}</span>
                `;
                container.appendChild(label);
            });

            // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¨­å®š
            const selectAllCEs = document.getElementById('selectAllCEs');
            if (selectAllCEs) {
                const total = container.querySelectorAll('.ce-filter').length;
                const checked = container.querySelectorAll('.ce-filter:checked').length;
                selectAllCEs.checked = total > 0 && checked === total;

                // æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒªã‚¢
                selectAllCEs.onchange = null;
                selectAllCEs.addEventListener('change', function() {
                    const isChecked = this.checked;
                    container.querySelectorAll('.ce-filter').forEach(cb => cb.checked = isChecked);
                    regenerateViews(); // å³æ™‚æ›´æ–°
                });
            }

            // å€‹åˆ¥CEå¤‰æ›´ã§å³æ™‚æ›´æ–°
            container.querySelectorAll('.ce-filter').forEach(cb => {
                cb.addEventListener('change', () => {
                    updateAllCECheckbox();
                    regenerateViews(); // å³æ™‚æ›´æ–°
                });
            });

            console.log('âœ… CEãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”Ÿæˆå®Œäº†:', globalCEList.length, 'å');
        }

        // ========== V1ç‰ˆæº–æ‹ ã®å€‹äººåˆ¥æ¥­å‹™æ™‚é–“ã‚°ãƒ©ãƒ• ==========
        function generateIndividualChart() {
            const selectedCEIds = getSelectedCEIds();
            const selectedDepartments = getSelectedDepartments();
            
            const filteredCEs = globalCEList.filter(ce => selectedCEIds.includes(ce.id));
            
            if (filteredCEs.length === 0) {
                if (chartInstances.individualChart) {
                    chartInstances.individualChart.destroy();
                    chartInstances.individualChart = null;
                }
                return;
            }

            const ctx = document.getElementById('individualChart');
            if (!ctx) return;

            if (chartInstances.individualChart) {
                chartInstances.individualChart.destroy();
            }

            const minuteMap = collectMinuteMapV1Style(filteredCEs, selectedDepartments, v2EventsByDate);
            const totalHoursByCE = computeTotalHoursV1Style(minuteMap, filteredCEs);

            const labels = totalHoursByCE.map(item => item.name);
            const data = totalHoursByCE.map(item => item.hours);

            chartInstances.individualChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å®ŸåŠ´åƒæ™‚é–“(æ™‚é–“)',
                        data: data,
                        backgroundColor: 'rgba(76, 175, 80, 0.6)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'æ™‚é–“ï¼ˆé‡è¤‡é™¤å¤–æ¸ˆã¿ï¼‰'
                            }
                        },
                        y: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 0,
                                minRotation: 0,
                                font: { size: 11 }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const ceName = context.label;
                                    const hours = context.parsed.x;
                                    const ceInfo = totalHoursByCE.find(item => item.name === ceName);
                                    
                                    let tooltip = `å®ŸåŠ´åƒæ™‚é–“: ${hours}æ™‚é–“`;
                                    
                                    if (ceInfo && ceInfo.daySchedules) {
                                        const dayLabels = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                                        let totalMinutes = 0;
                                        const dayMinuteCounts = [];
                                        
                                        currentDateRange.forEach(date => {
                                            const dateKey = formatDateAsISO(date);
                                            const minutesOnDay = ceInfo.daySchedules[dateKey] || 0;
                                            dayMinuteCounts.push(minutesOnDay);
                                            totalMinutes += minutesOnDay;
                                        });
                                        
                                        if (totalMinutes > 0) {
                                            const totalTasks = Math.round(totalMinutes / 30);
                                            tooltip += `\nç·æ¥­å‹™æ•°ï¼ˆæ¦‚ç®—ï¼‰: ${totalTasks}ä»¶`;
                                            
                                            const dayTaskSummary = currentDateRange.map((date, idx) => {
                                                const dayShortName = dayLabels[date.getDay()];
                                                const hoursForDay = Math.round((dayMinuteCounts[idx] / 60) * 10) / 10;
                                                return `${dayShortName}${hoursForDay}h`;
                                            }).join(' ');
                                            tooltip += `\næ—¥åˆ¥æ™‚é–“: ${dayTaskSummary}`;
                                        }
                                    }
                                    
                                    return tooltip;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ========== å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º ==========
        function generateTimeline() {
            console.log('ğŸ”„ å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆé–‹å§‹');
            const container = document.getElementById('timelineContainer');
            container.innerHTML = '';
            
            const selectedCEIds = getSelectedCEIds();
            const selectedDepartments = getSelectedDepartments();
            
            if (selectedCEIds.length === 0) {
                container.innerHTML = `
                    <div class="no-tasks-message">
                        <i class="fas fa-user-times text-3xl mb-4 block"></i>
                        <p class="text-lg font-bold mb-2">è¡¨ç¤ºã™ã‚‹CEã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                        <p>ä¸Šè¨˜ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‹ã‚‰è¡¨ç¤ºã—ãŸã„CEã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚</p>
                    </div>
                `;
                return;
            }
            
            let hasAnyData = false;
            
            selectedCEIds.forEach(ceId => {
                const ce = globalCEList.find(c => c.id === ceId);
                if (!ce) return;
                
                const ceElement = generateCETimeline(ce, selectedDepartments, container);
                if (ceElement) {
                    hasAnyData = true;
                }
            });
            
            if (!hasAnyData) {
                container.innerHTML = `
                    <div class="no-tasks-message">
                        <i class="fas fa-calendar-times text-3xl mb-4 block"></i>
                        <p class="text-lg font-bold mb-2">æŒ‡å®šæœŸé–“å†…ã«æ¥­å‹™é…ç½®ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <p>æœŸé–“ãƒ»éƒ¨é–€ãƒ»CEé¸æŠã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                `;
            }
        }

        function generateCETimeline(ce, selectedDepartments, container) {
            const ceEvents = collectCEEventsForDateRange(ce.id, selectedDepartments);
            
            const ceCard = document.createElement('div');
            ceCard.className = 'ce-area';
            
            const header = createCEHeader(ce, ceEvents);
            ceCard.appendChild(header);
            
            const timelineBody = createTimelineBody(ceEvents, ce.id);
            ceCard.appendChild(timelineBody);
            
            container.appendChild(ceCard);
            return ceCard;
        }

        function collectCEEventsForDateRange(ceId, selectedDepartments) {
            const ceEvents = {};

            currentDateRange.forEach(date => {
                const dateKey = formatDateAsISO(date);
                const dayEvents = v2EventsByDate[dateKey] || {};

                const eventsForThisCE = Object.values(dayEvents).filter(event => {
                    if (selectedDepartments.length && !selectedDepartments.includes(event.department)) return false;
                    
                    const assignedList = event.assignedCEs || [];
                    return assignedList.some(assigned => {
                        if (typeof assigned === 'string') return assigned === ceId;
                        if (assigned && typeof assigned === 'object') return assigned.id === ceId || assigned.name === ceId;
                        return false;
                    });
                });

                // æ¥­å‹™ãŒãªãã¦ã‚‚å‹¤å‹™çŠ¶æ…‹ãŒã‚ã‚Œã°æ—¥ã¨ã—ã¦å«ã‚ã‚‹
                const status = globalWorkStatusData[ceId]?.[dateKey];
                if (eventsForThisCE.length > 0 || (status && status !== '')) {
                    ceEvents[dateKey] = {
                        date: date,
                        events: eventsForThisCE.sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime))
                    };
                }
            });

            return ceEvents;
        }

        function createCEHeader(ce, ceEvents) {
            const totalTasks = Object.values(ceEvents).reduce((sum, day) => sum + day.events.length, 0);
            
            // å‹¤å‹™çŠ¶æ…‹ã®é›†è¨ˆ
            const statusCounts = {};
            currentDateRange.forEach(date => {
                const dateKey = formatDateAsISO(date);
                const status = globalWorkStatusData[ce.id]?.[dateKey];
                if (status && status !== '') {
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                }
            });

            const statusSummaryHtml = Object.entries(statusCounts).map(([status, count]) => {
                const def = WORK_STATUS_DEFINITIONS[status] || { label: status, color: '#B0BEC5' };
                return `<span class="status-badge" style="background:${def.color}">${def.label}:${count}</span>`;
            }).join('');

            const header = document.createElement('div');
            header.className = 'flex items-center justify-between mb-4';
            header.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-user mr-3 text-2xl" style="color: #3b82f6;"></i>
                    <div>
                        <h3 class="text-xl font-bold">${ce.name}</h3>
                    </div>
                </div>
                <div class="text-sm text-gray-600 flex items-center flex-wrap">
                    <span class="bg-white bg-opacity-70 px-3 py-1 rounded-full mr-2 mb-1">
                        æœŸé–“å†…ç·æ¥­å‹™: ${totalTasks}ä»¶
                    </span>
                    ${statusSummaryHtml}
                </div>
            `;
            
            return header;
        }

        function createTimelineBody(ceEvents, ceId) {
            const body = document.createElement('div');
            body.className = 'space-y-3';
            
            const timeScale = createTimeScale();
            body.appendChild(timeScale);
            
            const sortedEntries = Object.entries(ceEvents).sort((a, b) => {
                return a[1].date.getTime() - b[1].date.getTime();
            });
            
            sortedEntries.forEach(([dateKey, dayData]) => {
                const dayRow = createDayRow(dayData, ceId);
                body.appendChild(dayRow);
            });
            
            return body;
        }

        function createTimeScale() {
            const timeScale = document.createElement('div');
            timeScale.className = 'time-scale';
            
            for (let hour = displayStartHour; hour <= displayEndHour; hour += 2) {
                const timeLabel = document.createElement('div');
                timeLabel.textContent = `${hour.toString().padStart(2, '0')}:00`;
                timeLabel.style.flex = '1';
                timeLabel.style.textAlign = 'center';
                timeScale.appendChild(timeLabel);
            }
            
            return timeScale;
        }

        function createDayRow(dayData, ceId) {
            const dayRow = document.createElement('div');
            dayRow.className = 'timeline-day-row';
            
            // å‹¤å‹™çŠ¶æ…‹ã‚’å–å¾—ã—ã€èƒŒæ™¯è‰²ã¨ã—ã¦è–„ãé©ç”¨
            const dateKey = formatDateAsISO(dayData.date);
            const status = globalWorkStatusData[ceId]?.[dateKey];
            if (status && WORK_STATUS_DEFINITIONS[status]) {
                const statusColor = WORK_STATUS_DEFINITIONS[status].color;
                dayRow.style.backgroundColor = hexToRgba(statusColor, 0.12); // é€æ˜åº¦0.12ã§è–„ãé©ç”¨
            }

            const dayHeader = document.createElement('div');
            dayHeader.className = 'flex justify-between items-center mb-2';
            dayHeader.innerHTML = `
                <div class="font-bold text-sm">
                    ${formatDisplayDate(dayData.date)} (${getJapaneseDayName(dayData.date)})
                    ${status ? `<span class="ml-2 text-blue-700 font-medium">[${status}]</span>` : ''}
                </div>
                <div class="text-xs text-gray-600">
                    ${dayData.events.length}ä»¶ã®æ¥­å‹™
                </div>
            `;
            dayRow.appendChild(dayHeader);
            
            const track = createTimelineTrack(dayData);
            dayRow.appendChild(track);
            
            return dayRow;
        }

        function createTimelineTrack(dayData) {
            const track = document.createElement('div');
            track.className = 'timeline-track';
            track.style.height = Math.max(30, dayData.events.length * 26 + 6) + 'px';
            
            const totalMinutes = (displayEndHour - displayStartHour) * 60;
            
            dayData.events.forEach((event, eventIdx) => {
                const taskBar = createTaskBar(event, eventIdx, totalMinutes);
                if (taskBar) {
                    track.appendChild(taskBar);
                }
            });
            
            return track;
        }

        function createTaskBar(event, eventIdx, totalMinutes) {
            const startMinutes = timeToMinutes(event.startTime);
            const endMinutes = timeToMinutes(event.endTime);
            const displayStartMinutes = displayStartHour * 60;
            const displayEndMinutes = displayEndHour * 60;
            
            if (endMinutes <= displayStartMinutes || startMinutes >= displayEndMinutes) {
                return null;
            }
            
            const adjustedStart = Math.max(startMinutes, displayStartMinutes);
            const adjustedEnd = Math.min(endMinutes, displayEndMinutes);
            
            const left = ((adjustedStart - displayStartMinutes) / totalMinutes) * 100;
            const width = Math.max(2, ((adjustedEnd - adjustedStart) / totalMinutes) * 100);
            
            const taskBar = document.createElement('div');
            taskBar.className = 'task-bar';
            taskBar.style.left = left + '%';
            taskBar.style.width = width + '%';
            taskBar.style.top = (eventIdx * 26 + 3) + 'px';
            taskBar.style.backgroundColor = DEPARTMENT_COLORS[event.department];
            taskBar.style.opacity = '0.9';
            
            taskBar.title = [
                `æ¥­å‹™: ${event.name}`,
                `éƒ¨é–€: ${event.department}`,
                `æ™‚é–“: ${event.startTime}-${event.endTime}`,
                `ä»¶æ•°: ${event.count || 1}ä»¶`,
                `å¿…è¦äººæ•°: ${event.requiredPeople || 1}å`
            ].join('\n');
            
            let displayText = '';
            if (width > 25) {
                displayText = `${event.name} (${event.department})`;
            } else if (width > 15) {
                displayText = event.name;
            } else if (width > 8) {
                displayText = event.name.substring(0, 3) + '...';
            } else {
                displayText = 'â—';
            }
            
            taskBar.innerHTML = `
                <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 4px;">
                    ${displayText}
                </span>
            `;
            
            return taskBar;
        }

        // ========== ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ==========
        function timeToMinutes(timeString) {
            if (!timeString || !/^\d{1,2}:\d{2}$/.test(timeString)) return 0;
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function formatDateAsISO(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDisplayDate(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        }

        function getJapaneseDayName(date) {
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            return days[date.getDay()];
        }

        function getSelectedCEIds() {
            return Array.from(document.querySelectorAll('.ce-filter:checked')).map(cb => cb.value);
        }

        function getSelectedDepartments() {
            const list = Array.from(document.querySelectorAll('.department-filter:not([value="all"]):checked')).map(cb => cb.value);
            return list.length > 0 ? list : DEPARTMENTS;
        }

        function updateAllCECheckbox() {
            const allCheckbox = document.getElementById('selectAllCEs');
            const ceCheckboxes = document.querySelectorAll('.ce-filter');
            const checkedCount = document.querySelectorAll('.ce-filter:checked').length;
            
            if (allCheckbox) {
                allCheckbox.checked = checkedCount === ceCheckboxes.length;
            }
        }

        function updateAllDepartmentCheckbox() {
            const allCheckbox = document.querySelector('.department-filter[value="all"]');
            const deptCheckboxes = document.querySelectorAll('.department-filter:not([value="all"])');
            const checkedCount = document.querySelectorAll('.department-filter:not([value="all"]):checked').length;
            
            if (allCheckbox) {
                allCheckbox.checked = checkedCount === deptCheckboxes.length;
            }
        }

        // å³æ™‚æ›´æ–°ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function regenerateViews() {
            try {
                generateIndividualChart();
                generateTimeline();
                updateSummary();
                console.log('ğŸ”„ ãƒ“ãƒ¥ãƒ¼å†ç”Ÿæˆå®Œäº†');
            } catch (error) {
                console.error('âŒ ãƒ“ãƒ¥ãƒ¼å†ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showMessage(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            alert(message);
        }

        function resetFilters() {
            setPeriod('thisWeek');
            document.getElementById('displayStartTime').value = '07:00';
            document.getElementById('displayEndTime').value = '19:00';
            
            document.querySelectorAll('.ce-filter, .department-filter').forEach(cb => cb.checked = true);
            document.getElementById('selectAllCEs').checked = true;
        }

        function updateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            const selectedCEIds = getSelectedCEIds();
            const selectedDepartments = getSelectedDepartments();
            
            const filteredCEs = globalCEList.filter(ce => selectedCEIds.includes(ce.id));
            
            const minuteMap = collectMinuteMapV1Style(filteredCEs, selectedDepartments, v2EventsByDate);
            const totalHoursByCE = computeTotalHoursV1Style(minuteMap, filteredCEs);

            let totalTasks = 0;
            let totalWorkHours = 0;
            let activeCEs = 0;
            const totalStatusCounts = {};

            totalHoursByCE.forEach(item => {
                if (item.hours > 0) {
                    activeCEs++;
                    totalWorkHours += item.hours;
                    
                    Object.values(item.daySchedules).forEach(minutes => {
                        totalTasks += Math.round(minutes / 30);
                    });
                }
            });

            // å…¨CEåˆè¨ˆã®å‹¤å‹™çŠ¶æ…‹é›†è¨ˆ
            currentDateRange.forEach(date => {
                const dateKey = formatDateAsISO(date);
                filteredCEs.forEach(ce => {
                    const status = globalWorkStatusData[ce.id]?.[dateKey];
                    if (status && status !== '') {
                        totalStatusCounts[status] = (totalStatusCounts[status] || 0) + 1;
                    }
                });
            });

            const statusSummaryHtml = Object.entries(totalStatusCounts).map(([status, count]) => {
                const def = WORK_STATUS_DEFINITIONS[status] || { label: status, color: '#B0BEC5' };
                return `<span class="status-badge" style="background:${def.color}">${def.label}:${count}</span>`;
            }).join(' ');

            summaryContent.innerHTML = `
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-blue-600">${filteredCEs.length}</div>
                    <div class="text-xs text-gray-600">è¡¨ç¤ºCEæ•°</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-green-600">${activeCEs}</div>
                    <div class="text-xs text-gray-600">é…ç½®ã‚ã‚ŠCE</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-purple-600">${totalTasks}</div>
                    <div class="text-xs text-gray-600">ç·æ¥­å‹™é…ç½®æ•°</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-lg text-orange-600">${Math.round(totalWorkHours*10)/10}h</div>
                    <div class="text-xs text-gray-600">ç·å®ŸåŠ´åƒæ™‚é–“</div>
                </div>
                <div class="bg-white bg-opacity-70 p-3 rounded-lg text-center">
                    <div class="font-bold text-sm text-indigo-600">å‹¤å‹™çŠ¶æ…‹</div>
                    <div class="text-xs">${statusSummaryHtml || 'çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿ãªã—'}</div>
                </div>
            `;
        }

        function printCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const printWindow = window.open('', 'printCanvas');
            if (!printWindow) return;
            
            printWindow.document.write(`
                <html>
                    <head><title>å€‹äººåˆ¥åˆ†æã‚°ãƒ©ãƒ•</title></head>
                    <body style="margin: 20px; text-align: center;">
                        <h2>å€‹äººåˆ¥åˆ†æï¼ˆV1ç‰ˆæº–æ‹ ãƒ»é‡è¤‡é™¤å¤–ï¼‰</h2>
                        <img src="${canvas.toDataURL('image/png')}" style="max-width: 100%; height: auto;"/>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        console.log('âœ… å€‹äººåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ V2 èª­ã¿è¾¼ã¿å®Œäº†');
    </script>
</body>
</html>
