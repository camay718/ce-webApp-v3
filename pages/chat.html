<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éà„Éº„ÇØ - CE web App v3</title>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Theme -->
    <link rel="stylesheet" href="../css/theme-unified.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <!-- Custom Scripts -->
    <script src="../js/config/firebase-config.js"></script>
    <script src="../js/utils/auth-guard.js"></script>
    <script src="../js/utils/audit-logger.js"></script>
    <script src="../js/ui/theme-switcher.js"></script>

    <style>
        * { box-sizing: border-box; }

        body {
            background: var(--bg-gradient);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ========== „Éò„ÉÉ„ÉÄ„Éº ========== */
        .chat-header {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: var(--shadow-lg);
            z-index: 10;
        }

        .chat-header h1 {
            font-size: 1.375rem;
            font-weight: 600;
        }

        /* ========== „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà ========== */
        .chat-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ========== Â∑¶„Çµ„Ç§„Éâ„Éê„ÉºÔºà„É´„Éº„É†‰∏ÄË¶ßÔºâ ========== */
        .rooms-sidebar {
            width: 300px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .rooms-sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rooms-sidebar-header h2 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .rooms-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        .room-item {
            padding: 0.875rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .room-item:hover {
            background: rgba(45, 212, 191, 0.08);
        }

        .room-item.active {
            background: rgba(45, 212, 191, 0.12);
            border-left-color: var(--accent-color);
        }

        .room-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(45, 212, 191, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
            border: 1px solid rgba(45, 212, 191, 0.3);
        }

        .room-info {
            flex: 1;
            overflow: hidden;
        }

        .room-name {
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .room-last-message {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 0.2rem;
        }

        .room-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.375rem;
            flex-shrink: 0;
        }

        .room-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .unread-badge {
            background: #FF5722;
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            padding: 0 5px;
            font-size: 0.6875rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ========== Âè≥„É°„Ç§„É≥„Ç®„É™„Ç¢Ôºà„ÉÅ„É£„ÉÉ„ÉàÔºâ ========== */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Á©∫„ÅÆÁä∂ÊÖã */
        .chat-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            gap: 1rem;
        }

        .chat-empty i {
            font-size: 4rem;
            opacity: 0.4;
        }

        /* „ÉÅ„É£„ÉÉ„Éà„É´„Éº„É† */
        .chat-room {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .chat-room.active {
            display: flex;
        }

        /* „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢„Éò„ÉÉ„ÉÄ„Éº */
        .chat-room-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .chat-room-name {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .chat-room-members {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        /* „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        /* Êó•‰ªòÂå∫Âàá„Çä */
        .date-divider {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.75rem;
            padding: 0.75rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .date-divider::before,
        .date-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--glass-border);
        }

        /* „É°„ÉÉ„Çª„Éº„Ç∏„Éê„Éñ„É´ */
        .message-row {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .message-row.mine {
            flex-direction: row-reverse;
        }

        .message-avatar-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(45, 212, 191, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
            border: 1px solid rgba(45, 212, 191, 0.3);
        }

        .message-content-wrap {
            max-width: 65%;
            display: flex;
            flex-direction: column;
        }

        .message-row.mine .message-content-wrap {
            align-items: flex-end;
        }

        .message-sender-name {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            padding-left: 0.25rem;
        }

        .message-bubble {
            padding: 0.625rem 1rem;
            border-radius: 16px;
            font-size: 0.9375rem;
            line-height: 1.5;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .message-row.mine .message-bubble {
            background: var(--accent-color);
            color: #0B1220;
            border-radius: 16px 16px 4px 16px;
        }

        .message-row.others .message-bubble {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            border-radius: 16px 16px 16px 4px;
        }

        .message-footer {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            margin-top: 0.25rem;
            padding: 0 0.25rem;
        }

        .message-time {
            font-size: 0.6875rem;
            color: var(--text-secondary);
        }

        .message-read {
            font-size: 0.6875rem;
            color: var(--accent-color);
        }

        /* ÂÖ•Âäõ„Ç®„É™„Ç¢ */
        .chat-input-area {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--glass-border);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            flex-shrink: 0;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: rgba(17, 24, 39, 0.4);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            color: var(--text-primary);
            font-size: 0.9375rem;
            resize: none;
            max-height: 120px;
            line-height: 1.5;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.1);
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--accent-color);
            color: #0B1220;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #26bfa5;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(45, 212, 191, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* ========== „Éú„Çø„É≥ÂÖ±ÈÄö ========== */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--accent-color);
            color: #0B1220;
        }

        .btn-primary:hover {
            background: #26bfa5;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--glass-bg);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            border-color: var(--accent-color);
        }

        /* ========== „É¢„Éº„ÉÄ„É´ ========== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.375rem;
            color: var(--text-secondary);
            cursor: pointer;
            line-height: 1;
            padding: 0.25rem;
        }

        .close-modal:hover { color: var(--text-primary); }

        /* „ÉÅ„É£„ÉÉ„Éà„Çø„Ç§„ÉóÂàáÊõø */
        .chat-type-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .type-tab {
            flex: 1;
            padding: 0.625rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
        }

        .type-tab.active {
            background: rgba(45, 212, 191, 0.15);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        /* „Éï„Ç©„Éº„É† */
        .form-group { margin-bottom: 1.25rem; }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9375rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(17, 24, 39, 0.4);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9375rem;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.1);
        }

        /* „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„É™„Çπ„Éà */
        .user-select-list {
            max-height: 260px;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            background: rgba(17, 24, 39, 0.3);
        }

        .user-select-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .user-select-item:last-child { border-bottom: none; }

        .user-select-item:hover { background: rgba(45, 212, 191, 0.07); }

        .user-select-item.selected { background: rgba(45, 212, 191, 0.12); }

        .user-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        }

        .user-select-item.selected .user-checkbox {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .user-select-item.selected .user-checkbox::after {
            content: '‚úì';
            color: #0B1220;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .user-display-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .user-role-badge {
            font-size: 0.6875rem;
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            margin-left: auto;
        }

        .role-admin { background: rgba(239,68,68,0.2); color: #FCA5A5; }
        .role-editor { background: rgba(234,179,8,0.2); color: #FDE68A; }
        .role-user { background: rgba(45,212,191,0.15); color: var(--accent-color); }

        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(17, 24, 39, 0.3); }
        ::-webkit-scrollbar-thumb { background: rgba(45, 212, 191, 0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(45, 212, 191, 0.5); }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 768px) {
            .rooms-sidebar { width: 240px; }
            .messages-area { padding: 1rem; }
            .chat-input-area { padding: 0.75rem 1rem; }
            .modal-content { padding: 1.5rem; }
        }

        @media (max-width: 520px) {
            .rooms-sidebar { display: none; }
            .rooms-sidebar.show { display: flex; position: absolute; z-index: 20; height: 100%; }
        }
    </style>
</head>
<body>

    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="chat-header">
        <div style="display:flex; align-items:center; gap:0.75rem;">
            <button id="sidebarToggleBtn" class="btn btn-secondary"
                    style="display:none; padding:0.5rem 0.75rem;"
                    onclick="document.querySelector('.rooms-sidebar').classList.toggle('show')">
                <i class="fas fa-bars"></i>
            </button>
            <h1>üí¨ „Éà„Éº„ÇØ</h1>
        </div>
        <div style="display:flex; gap:0.75rem; align-items:center;">
            <button id="newChatBtn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Êñ∞Ë¶è„ÉÅ„É£„ÉÉ„Éà
            </button>
            <button onclick="window.location.href='../pages/home.html'" class="btn btn-secondary">
                <i class="fas fa-home"></i> „Éõ„Éº„É†„Å∏Êàª„Çã
            </button>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà -->
    <div class="chat-body">

        <!-- Â∑¶„Çµ„Ç§„Éâ„Éê„ÉºÔºà„É´„Éº„É†‰∏ÄË¶ßÔºâ -->
        <div class="rooms-sidebar">
            <div class="rooms-sidebar-header">
                <h2>„ÉÅ„É£„ÉÉ„Éà‰∏ÄË¶ß</h2>
                <span id="totalUnreadBadge" style="display:none;"
                      class="unread-badge"></span>
            </div>
            <div id="roomsList" class="rooms-list">
                <div style="text-align:center; padding:2rem; color:var(--text-secondary);">
                    <i class="fas fa-spinner fa-spin"></i> Ë™≠„ÅøËæº„Åø‰∏≠...
                </div>
            </div>
        </div>

        <!-- Âè≥„É°„Ç§„É≥„Ç®„É™„Ç¢ -->
        <div class="chat-main">

            <!-- Á©∫Áä∂ÊÖãÔºà„É´„Éº„É†Êú™ÈÅ∏ÊäûÔºâ -->
            <div id="chatEmpty" class="chat-empty">
                <i class="fas fa-comments"></i>
                <p style="font-size:1.125rem; font-weight:500;">„ÉÅ„É£„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                <p style="font-size:0.875rem;">Â∑¶„ÅÆ‰∏ÄË¶ß„Åã„Çâ„ÉÅ„É£„ÉÉ„Éà„ÇíÈÅ∏„Å∂„Åã„ÄÅ<br>„ÄåÊñ∞Ë¶è„ÉÅ„É£„ÉÉ„Éà„Äç„Åß‰ºöË©±„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ</p>
            </div>

            <!-- „ÉÅ„É£„ÉÉ„Éà„É´„Éº„É† -->
            <div id="chatRoom" class="chat-room">
                <!-- „ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†„Éò„ÉÉ„ÉÄ„Éº -->
                <div class="chat-room-header">
                    <div class="room-avatar" id="roomHeaderAvatar">üí¨</div>
                    <div>
                        <div class="chat-room-name" id="roomHeaderName">„É´„Éº„É†Âêç</div>
                        <div class="chat-room-members" id="roomHeaderMembers"></div>
                    </div>
                </div>

                <!-- „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ -->
                <div id="messagesArea" class="messages-area"></div>

                <!-- ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
                <div class="chat-input-area">
                    <textarea id="chatInput"
                              class="chat-input"
                              rows="1"
                              placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ... (Shift+Enter„ÅßÊîπË°å)"
                              maxlength="2000"></textarea>
                    <button id="sendBtn" class="send-btn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Êñ∞Ë¶è„ÉÅ„É£„ÉÉ„Éà„É¢„Éº„ÉÄ„É´ -->
    <div id="newChatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Êñ∞Ë¶è„ÉÅ„É£„ÉÉ„Éà</h3>
                <button class="close-modal"
                        onclick="document.getElementById('newChatModal').classList.remove('active')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- „Çø„Ç§„ÉóÈÅ∏Êäû„Çø„Éñ -->
            <div class="chat-type-tabs">
                <button class="type-tab active" id="tabDirect"
                        onclick="window.chatManager.switchChatType('direct')">
                    <i class="fas fa-user"></i> 1ÂØæ1„ÉÅ„É£„ÉÉ„Éà
                </button>
                <button class="type-tab" id="tabGroup"
                        onclick="window.chatManager.switchChatType('group')">
                    <i class="fas fa-users"></i> „Ç∞„É´„Éº„Éó„ÉÅ„É£„ÉÉ„Éà
                </button>
            </div>

            <!-- „Ç∞„É´„Éº„ÉóÂêçÔºà„Ç∞„É´„Éº„Éó„ÅÆ„ÅøË°®Á§∫Ôºâ -->
            <div id="groupNameSection" class="form-group" style="display:none;">
                <label class="form-label">„Ç∞„É´„Éº„ÉóÂêç</label>
                <input type="text" id="groupNameInput" class="form-input"
                       placeholder="„Ç∞„É´„Éº„ÉóÂêç„ÇíÂÖ•ÂäõÔºàÁúÅÁï•ÂèØÔºâ" maxlength="50">
            </div>

            <!-- „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû -->
            <div class="form-group">
                <label class="form-label" id="userSelectLabel">
                    „ÉÅ„É£„ÉÉ„Éà„Åô„ÇãÁõ∏Êâã„ÇíÈÅ∏Êäû
                </label>
                <div id="userSelectList" class="user-select-list">
                    <div style="text-align:center; padding:1.5rem; color:var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin"></i> „É¶„Éº„Ç∂„ÉºË™≠„ÅøËæº„Åø‰∏≠...
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:0.75rem; justify-content:flex-end;">
                <button class="btn btn-secondary"
                        onclick="document.getElementById('newChatModal').classList.remove('active')">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
                <button id="createChatBtn" class="btn btn-primary" disabled>
                    <i class="fas fa-plus"></i> ‰ΩúÊàê„Åô„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/modules/user-manager.js"></script>
    <script src="../js/modules/chat-manager.js"></script>
</body>
</html>
