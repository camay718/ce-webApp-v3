<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>トーク - CE web App v3</title>

  <!-- 外部ライブラリ -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../css/theme-unified.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="../js/config/firebase-config.js"></script>
  <script src="../js/utils/auth-guard.js"></script>
  <script src="../js/utils/audit-logger.js"></script>
  <script src="../js/ui/theme-switcher.js"></script>

  <style>
    /* ============================================================
       レイアウト基盤
    ============================================================ */
    *, *::before, *::after { box-sizing: border-box; }

    body.theme-unified {
      margin: 0;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* ============================================================
       ヘッダー
    ============================================================ */
    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      height: 56px;
      flex-shrink: 0;
      background: var(--glass-bg-strong);
      border-bottom: 1px solid var(--glass-border);
      backdrop-filter: blur(12px);
      z-index: 20;
    }
    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .chat-header h1 {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-strong);
      margin: 0;
      letter-spacing: 0.02em;
    }
    .hdr-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s, background 0.2s;
      border: none;
      text-decoration: none;
    }
    .hdr-btn.primary {
      background: var(--brand-primary);
      color: #0B1220;
    }
    .hdr-btn.primary:hover { opacity: 0.85; }
    .hdr-btn.ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--glass-border);
    }
    .hdr-btn.ghost:hover { background: var(--glass-border); color: var(--text-color); }

    /* ============================================================
       ボディ（サイドバー＋メイン）
    ============================================================ */
    .chat-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ============================================================
       サイドバー（ルーム一覧）
    ============================================================ */
    .rooms-sidebar {
      width: 272px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      background: var(--surface-1);
      border-right: 1px solid var(--glass-border);
      overflow: hidden;
      transition: width 0.25s;
    }
    .sidebar-top {
      padding: 12px 14px;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      text-transform: uppercase;
      border-bottom: 1px solid var(--glass-border);
      flex-shrink: 0;
    }
    .rooms-list {
      flex: 1;
      overflow-y: auto;
      padding: 6px 0;
    }
    .rooms-list::-webkit-scrollbar { width: 3px; }
    .rooms-list::-webkit-scrollbar-thumb { background: var(--glass-border-strong); border-radius: 2px; }

    .room-item {
      display: flex;
      align-items: center;
      gap: 11px;
      padding: 11px 14px;
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: background 0.15s, border-color 0.15s;
    }
    .room-item:hover { background: rgba(255,255,255,0.04); }
    .room-item.active {
      background: rgba(45, 212, 191, 0.08);
      border-left-color: var(--brand-primary);
    }
    .room-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--brand-primary), #6366f1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 700;
      color: #0B1220;
      flex-shrink: 0;
    }
    .room-avatar.grp { background: linear-gradient(135deg, #a855f7, #ec4899); }
    .room-info { flex: 1; min-width: 0; }
    .room-name {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-strong);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .room-last {
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }
    .room-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      flex-shrink: 0;
    }
    .room-time { font-size: 0.68rem; color: var(--text-muted); }
    .unread-badge {
      background: #ef4444;
      color: #fff;
      border-radius: 10px;
      padding: 1px 7px;
      font-size: 0.7rem;
      font-weight: 700;
      min-width: 20px;
      text-align: center;
    }

    /* ============================================================
       チャットメインエリア
    ============================================================ */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    /* ルームヘッダー */
    .room-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: var(--glass-bg-strong);
      border-bottom: 1px solid var(--glass-border);
      flex-shrink: 0;
    }
    .room-header .room-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text-strong);
    }
    .room-header .room-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 1px;
    }

    /* 空状態 */
    .chat-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      gap: 14px;
    }
    .chat-empty i { font-size: 3rem; opacity: 0.25; }
    .chat-empty p  { font-size: 0.9rem; }

    /* ============================================================
       メッセージエリア
    ============================================================ */
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .messages-area::-webkit-scrollbar { width: 4px; }
    .messages-area::-webkit-scrollbar-thumb { background: var(--glass-border-strong); border-radius: 2px; }

    /* 日付区切り */
    .date-sep {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 14px 0 8px;
    }
    .date-sep::before, .date-sep::after {
      content: '';
      flex: 1;
      border-top: 1px solid var(--glass-border);
    }
    .date-sep span {
      font-size: 0.7rem;
      color: var(--text-muted);
      white-space: nowrap;
      background: var(--surface-1);
      padding: 2px 10px;
      border-radius: 10px;
    }

    /* ============================================================
       吹き出し
    ============================================================ */
    .msg-row {
      display: flex;
      flex-direction: column;
      max-width: 72%;
      position: relative;
    }
    /* 自分: 右寄せ */
    .msg-row.self {
      align-self: flex-end;
      align-items: flex-end;
    }
    /* 相手: 左寄せ */
    .msg-row.other {
      align-self: flex-start;
      align-items: flex-start;
    }
    /* システム: 中央 */
    .msg-row.system {
      align-self: center;
      max-width: 88%;
    }

    /* 送信者名（相手のみ） */
    .msg-sender {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-bottom: 3px;
      padding: 0 6px;
    }

    /* アバター＋バブル の横並び */
    .msg-bubble-row {
      display: flex;
      align-items: flex-end;
      gap: 7px;
    }
    .msg-row.self .msg-bubble-row { flex-direction: row-reverse; }

    /* アバター（相手のみ） */
    .msg-av {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--brand-primary), #6366f1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.72rem;
      font-weight: 700;
      color: #0B1220;
      flex-shrink: 0;
    }

    /* バブル本体 */
    .msg-bubble {
      padding: 9px 13px;
      border-radius: 16px;
      font-size: 0.875rem;
      line-height: 1.55;
      word-break: break-word;
      white-space: pre-wrap;
      position: relative;
    }
    /* 自分: ティール系グリーン */
    .msg-row.self .msg-bubble {
      background: #0d9488;           /* teal-600 */
      color: #f0fdfa;                /* teal-50 */
      border-bottom-right-radius: 4px;
    }
    /* 相手: ダークスモーク */
    .msg-row.other .msg-bubble {
      background: rgba(255,255,255,0.09);
      color: var(--text-strong);     /* #F9FAFB */
      border-bottom-left-radius: 4px;
      border: 1px solid var(--glass-border);
    }
    /* システム */
    .msg-row.system .msg-bubble {
      background: rgba(255,255,255,0.05);
      color: var(--text-muted);
      font-size: 0.75rem;
      text-align: center;
      border-radius: 10px;
      padding: 5px 14px;
    }

    /* バブル下メタ（時刻・既読） */
    .msg-meta {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 2px;
      padding: 0 4px;
      font-size: 0.68rem;
    }
    .msg-row.self .msg-meta { flex-direction: row-reverse; }
    .msg-time  { color: var(--text-muted); }
    .msg-read  { color: var(--brand-primary); }
    .msg-edited{ color: var(--text-muted); font-style: italic; }

    /* ホバーアクション（削除・編集）*/
    .msg-actions {
      display: none;
      align-items: center;
      gap: 3px;
    }
    .msg-row:hover .msg-actions { display: flex; }
    .act-btn {
      width: 26px;
      height: 26px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.72rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--surface-1);
      color: var(--text-muted);
      transition: background 0.15s, color 0.15s;
    }
    .act-btn:hover       { background: var(--brand-primary); color: #0B1220; }
    .act-btn.del:hover   { background: #ef4444; color: #fff; }

    /* ============================================================
       入力エリア
    ============================================================ */
    .input-area {
      padding: 12px 16px;
      background: var(--glass-bg-strong);
      border-top: 1px solid var(--glass-border);
      display: flex;
      gap: 10px;
      align-items: flex-end;
      flex-shrink: 0;
    }
    .input-wrap { flex: 1; display: flex; flex-direction: column; gap: 3px; }
    .chat-textarea {
      width: 100%;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--glass-border-strong);
      border-radius: 12px;
      padding: 10px 14px;
      color: var(--text-strong);
      font-size: 0.875rem;
      line-height: 1.5;
      resize: none;
      outline: none;
      min-height: 44px;
      max-height: 130px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .chat-textarea::placeholder { color: var(--text-muted); }
    .chat-textarea:focus { border-color: var(--brand-primary); }
    .input-hint {
      font-size: 0.68rem;
      color: var(--text-muted);
      text-align: right;
      padding-right: 2px;
    }
    .send-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: none;
      background: var(--brand-primary);
      color: #0B1220;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: opacity 0.2s, transform 0.15s;
    }
    .send-btn:hover:not(:disabled) { opacity: 0.85; transform: scale(1.05); }
    .send-btn:disabled { background: var(--glass-border-strong); color: var(--text-muted); cursor: not-allowed; transform: none; }

    /* ============================================================
       モーダル共通
    ============================================================ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.hidden { display: none; }
    .modal-box {
      background: var(--surface-1);
      border: 1px solid var(--glass-border-strong);
      border-radius: 16px;
      width: 100%;
      max-width: 440px;
      padding: 24px;
      position: relative;
    }
    .modal-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-strong);
      margin: 0 0 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .modal-close {
      position: absolute;
      top: 14px;
      right: 16px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 1.1rem;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 6px;
      transition: background 0.15s;
    }
    .modal-close:hover { background: var(--glass-border); color: var(--text-color); }

    /* ============================================================
       新規チャットモーダル
    ============================================================ */
    .tab-row {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
    }
    .tab-btn {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--glass-border);
      background: transparent;
      color: var(--text-muted);
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: rgba(45,212,191,0.12);
      border-color: var(--brand-primary);
      color: var(--brand-primary);
    }
    .grp-name-input {
      width: 100%;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      padding: 9px 12px;
      color: var(--text-strong);
      font-size: 0.875rem;
      margin-bottom: 12px;
      outline: none;
      display: none;
      font-family: inherit;
    }
    .grp-name-input:focus { border-color: var(--brand-primary); }
    .user-select-list {
      max-height: 230px;
      overflow-y: auto;
      border: 1px solid var(--glass-border);
      border-radius: 10px;
      margin-bottom: 14px;
    }
    .user-select-list::-webkit-scrollbar { width: 3px; }
    .user-select-list::-webkit-scrollbar-thumb { background: var(--glass-border-strong); }
    .usr-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .usr-item:hover { background: rgba(255,255,255,0.04); }
    .usr-item.sel   { background: rgba(45,212,191,0.08); }
    .usr-av {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--brand-primary), #6366f1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
      color: #0B1220;
      flex-shrink: 0;
    }
    .usr-name { font-size: 0.875rem; color: var(--text-strong); flex: 1; }
    .usr-check {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1.5px solid var(--glass-border-strong);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      color: transparent;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .usr-item.sel .usr-check {
      background: var(--brand-primary);
      border-color: var(--brand-primary);
      color: #0B1220;
    }
    .create-btn {
      width: 100%;
      padding: 11px;
      background: var(--brand-primary);
      color: #0B1220;
      border: none;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .create-btn:hover:not(:disabled) { opacity: 0.85; }
    .create-btn:disabled { background: var(--glass-border-strong); color: var(--text-muted); cursor: not-allowed; }

    /* 編集モーダル textarea */
    .edit-textarea {
      width: 100%;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--glass-border-strong);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text-strong);
      font-size: 0.875rem;
      resize: vertical;
      min-height: 80px;
      outline: none;
      font-family: inherit;
      line-height: 1.5;
    }
    .edit-textarea:focus { border-color: var(--brand-primary); }
    .edit-footer {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .edit-save {
      flex: 1;
      padding: 9px;
      background: var(--brand-primary);
      color: #0B1220;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 700;
      cursor: pointer;
    }
    .edit-cancel {
      flex: 1;
      padding: 9px;
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      font-size: 0.875rem;
      cursor: pointer;
    }

    /* ============================================================
       スマートフォン対応（≤ 600px）
    ============================================================ */
    @media (max-width: 600px) {
      .rooms-sidebar {
        position: absolute;
        top: 56px; left: 0; bottom: 0;
        z-index: 50;
        width: 80vw;
        max-width: 300px;
        transform: translateX(-100%);
        transition: transform 0.25s;
        box-shadow: 4px 0 24px rgba(0,0,0,0.5);
      }
      .rooms-sidebar.sp-open { transform: translateX(0); }
      .sp-toggle { display: flex !important; }
      .sp-backdrop {
        display: none;
        position: absolute;
        top: 56px; left: 0; right: 0; bottom: 0;
        z-index: 40;
        background: rgba(0,0,0,0.45);
      }
      .sp-backdrop.sp-open { display: block; }
    }
    .sp-toggle { display: none; }
  </style>
</head>

<body class="theme-unified">

  <!-- ヘッダー -->
  <div class="chat-header">
    <div class="chat-header-left">
      <!-- スマホ用サイドバートグル -->
      <button class="hdr-btn ghost sp-toggle" id="spToggleBtn" title="ルーム一覧">
        <i class="fas fa-bars"></i>
      </button>
      <h1>
        <i class="fas fa-comments" style="color:var(--brand-primary); margin-right:8px;"></i>
        トーク
      </h1>
      <span id="totalUnreadBadge" class="unread-badge" style="display:none;"></span>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="hdr-btn primary" id="newChatBtn">
        <i class="fas fa-plus"></i> 新規トーク
      </button>
      <a href="home.html" class="hdr-btn ghost">
        <i class="fas fa-home"></i>
      </a>
    </div>
  </div>

  <!-- ボディ -->
  <div class="chat-body" style="position:relative;">

    <!-- スマホ用背景幕 -->
    <div class="sp-backdrop" id="spBackdrop"></div>

    <!-- ── サイドバー ── -->
    <div class="rooms-sidebar" id="roomsSidebar">
      <div class="sidebar-top">トークルーム</div>
      <div class="rooms-list" id="roomsList">
        <div style="padding:24px 16px; text-align:center; color:var(--text-muted); font-size:0.82rem;">
          <div class="spinner" style="margin: 0 auto 10px;"></div>
          読み込み中…
        </div>
      </div>
    </div>

    <!-- ── チャットメイン ── -->
    <div class="chat-main">

      <!-- 未選択状態 -->
      <div class="chat-empty" id="chatEmpty">
        <i class="fas fa-comments"></i>
        <p>ルームを選んでください</p>
        <button class="hdr-btn primary" id="emptyNewBtn">
          <i class="fas fa-plus"></i> 新しいトークを始める
        </button>
      </div>

      <!-- 選択中ルーム -->
      <div id="chatRoomArea" style="display:none; flex-direction:column; height:100%;">

        <!-- ルームヘッダー -->
        <div class="room-header">
          <div class="room-avatar" id="chatRoomAvatar">?</div>
          <div>
            <div class="room-title"  id="chatRoomTitle">-</div>
            <div class="room-sub"    id="chatRoomSub"></div>
          </div>
        </div>

        <!-- メッセージ -->
        <div class="messages-area" id="messagesArea"></div>

        <!-- 入力エリア -->
        <div class="input-area">
          <div class="input-wrap">
            <textarea class="chat-textarea" id="chatInput"
              placeholder="メッセージを入力… (Shift+Enter で改行)" rows="1"></textarea>
            <div class="input-hint">Enter: 改行　　送信ボタン: 送信</div>
          </div>
          <button class="send-btn" id="sendBtn" disabled title="送信 (Ctrl+Enter)">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>

      </div><!-- /chatRoomArea -->
    </div><!-- /chat-main -->
  </div><!-- /chat-body -->


  <!-- ══════════════════════════════════════
       新規トークモーダル
  ══════════════════════════════════════ -->
  <div class="modal-overlay hidden" id="newChatModal">
    <div class="modal-box">
      <button class="modal-close" id="modalCloseBtn">
        <i class="fas fa-times"></i>
      </button>
      <div class="modal-title">
        <i class="fas fa-plus-circle" style="color:var(--brand-primary);"></i>
        新規トーク
      </div>

      <div class="tab-row">
        <button class="tab-btn active" id="tab1on1">
          <i class="fas fa-user"></i> 1対1
        </button>
        <button class="tab-btn" id="tabGroup">
          <i class="fas fa-users"></i> グループ
        </button>
      </div>

      <input type="text" id="groupNameInput" class="grp-name-input"
             placeholder="グループ名を入力">

      <div class="user-select-list" id="userSelectList"></div>

      <button class="create-btn" id="createRoomBtn" disabled>
        <i class="fas fa-check"></i> 作成する
      </button>
    </div>
  </div>

  <!-- ══════════════════════════════════════
       メッセージ編集モーダル
  ══════════════════════════════════════ -->
  <div class="modal-overlay hidden" id="editModal">
    <div class="modal-box">
      <button class="modal-close"
        onclick="document.getElementById('editModal').classList.add('hidden')">
        <i class="fas fa-times"></i>
      </button>
      <div class="modal-title">
        <i class="fas fa-edit" style="color:var(--brand-primary);"></i>
        メッセージを編集
      </div>
      <textarea class="edit-textarea" id="editInput" rows="3"></textarea>
      <div class="edit-footer">
        <button class="edit-save"   onclick="chatManager.submitEdit()">保存</button>
        <button class="edit-cancel"
          onclick="document.getElementById('editModal').classList.add('hidden')">
          キャンセル
        </button>
      </div>
    </div>
  </div>


  <!-- スクリプト -->
  <script src="../js/modules/user-manager.js"></script>
  <script src="../js/modules/chat-manager.js"></script>
</body>
</html>
