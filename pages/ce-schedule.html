<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤å‹™è¡¨ç®¡ç† - CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</title>
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/theme-unified.css?v=20241217">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="../js/config/firebase-config.js"></script>
    <script src="../js/core/auth-guard.js"></script>

    <!-- ç›£æŸ»ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ  -->
<script src="../js/utils/audit-logger.js"></script>

    <style>
        /* å‹¤å‹™è¡¨ç®¡ç†å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.schedule-layout {
    display: flex;
    /* min-height: 100vh; ã‚’å‰Šé™¤ */
}

        .schedule-sidebar {
            width: 300px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: relative;
            flex-shrink: 0;
            z-index: 90;
        }

.schedule-sidebar.collapsed {
    width: 60px;
    transform: none;
}

        .sidebar-content {
            padding: 20px;
            width: 300px;
            transition: opacity 0.3s ease;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-toggle {
            position: absolute;
            top: 15px;
            right: -15px;
            background: var(--brand-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            z-index: 101;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: right 0.3s ease;
        }

        .schedule-sidebar.collapsed .sidebar-toggle {
            right: -45px;
        }

.schedule-main {
    /* flex-grow: 1; ã‚’å‰Šé™¤ */
    padding: 20px;
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
}

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚±ãƒ¼ãƒ«è¡¨ç¤ºå¯¾å¿œ */
.work-schedule-table-wrapper {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-top: 20px;
    margin-bottom: 40px;
    position: relative;
    min-height: calc(800px + 336px); /* 14è¡Œåˆ†(336px)ã‚’è¿½åŠ  */
    overflow: visible; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Œå…¨ç„¡åŠ¹åŒ– */
}

        .work-schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            min-width: 1000px;
            transform-origin: top left;
        }

        .work-schedule-table th,
        .work-schedule-table td {
            border: 1px solid #e0e0e0;
            padding: 2px;
            text-align: center;
            vertical-align: middle;
            height: 24px;
            overflow: hidden;
            white-space: nowrap;
        }

        .work-schedule-table th {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 8px;
        }

        /* å›ºå®šåˆ— */
        .work-schedule-table .name-header,
        .work-schedule-table .name-cell {
            position: sticky;
            left: 30px;
            background: white;
            z-index: 15;
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            text-align: left;
            padding-left: 6px;
        }

        .work-schedule-table .name-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            z-index: 20;
        }

        /* å‹¤å‹™åŒºåˆ†åˆ¥èƒŒæ™¯è‰² */
        .work-schedule-table .work-cell.type-ope { 
            background: #07E1FF; 
            color: #1E3A8A; 
        }

        .work-schedule-table .work-cell.type-ope.status-A1 { 
            background: #0000FF !important; 
            color: white !important; 
        }

        .work-schedule-table .work-cell.type-me { 
            background: #CCFFCC; 
            color: #006400; 
        }

        .work-schedule-table .work-cell.type-hd { 
            background: #FFBCD4; 
            color: #8B008B; 
        }

        .work-schedule-table .work-cell.type-flex { 
            background: #FFFF00; 
            color: #B8860B; 
        }

        /* éå‹¤å‹™çŠ¶æ…‹(ç™½è‰²è¡¨ç¤º) */
        .work-schedule-table .work-cell.status-é,
        .work-schedule-table .work-cell.status-Ã—,
        .work-schedule-table .work-cell.status-å¹´,
        .work-schedule-table .work-cell.status-å‡º,
        .work-schedule-table .work-cell.status-ç ” {
            background: white !important;
            color: #333 !important;
            border: 1px solid #ddd !important;
        }

                /* è‡ªç”±å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ(ç™½è‰²è¡¨ç¤º) */
        .work-schedule-table .work-cell.status-text {
            background: #FFFFFF !important;
            color: #333 !important;
            border: 1px solid #ddd !important;
        }

        /* ä¼‘æ—¥ã‚»ãƒ« */
        .work-schedule-table .work-cell.holiday {
            background: white !important;
            color: #333 !important;
            border: 1px solid #ddd !important;
        }

        /* å¸Œæœ›å‹¤å‹™ */
        .work-schedule-table .work-cell.desired {
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 2px;
        }

        /* ã‚µãƒãƒªãƒ¼ã‚»ãƒ« */
        .work-schedule-table .summary-cell {
            background: #f8f9fa;
            font-weight: 500;
            width: 30px;
            min-width: 30px;
            max-width: 30px;
            font-size: 7px;
        }

        /* é›†è¨ˆè¡Œã‚¹ã‚¿ã‚¤ãƒ« */
        .work-schedule-table .footer-summary-row {
            background: #f1f3f4 !important;
            border-top: 2px solid #dee2e6 !important;
        }

        .work-schedule-table .footer-summary-row td {
            font-weight: 600;
            font-size: 7px;
            padding: 1px !important;
        }

        .work-schedule-table .type-label {
            background: #e9ecef !important;
            font-weight: 700;
            text-align: left !important;
            padding-left: 3px !important;
        }

        .work-schedule-table .warning-count {
            color: #dc3545 !important;
            font-weight: 700;
            background: #ffe6e6 !important;
        }

        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å¯¾å¿œ */
        @media (max-width: 768px) {
            .schedule-sidebar {
                position: fixed;
                top: 0;
                bottom: 0;
                left: -300px;
                width: 300px;
                height: 100vh;
                transform: translateX(0);
                transition: left 0.3s ease;
                z-index: 1000;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(10px);
                border-radius: 0 8px 8px 0;
                border-right: 2px solid #e5e7eb;
                overflow-y: auto;
                box-shadow: 2px 0 20px rgba(0, 0, 0, 0.15);
            }
            
            .schedule-sidebar.expanded {
                left: 0;
            }
            
            .sidebar-toggle {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--brand-primary);
                color: white;
                border-radius: 50%;
                width: 56px;
                height: 56px;
                border: none;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1001;
                font-size: 18px;
            }
            
            .schedule-main {
                margin-left: 0;
                padding: 12px;
                padding-bottom: 80px;
                width: 100%;
            }
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼åç´æ™‚ã®å®Œå…¨éè¡¨ç¤º */
.schedule-sidebar.collapsed .sidebar-content {
    opacity: 0;
    pointer-events: none;
    overflow: hidden;
}

/* Noåˆ—ã®å›ºå®šã‚¹ã‚¿ã‚¤ãƒ« */
.work-schedule-table .no-header,
.work-schedule-table .no-cell {
    position: sticky;
    left: 0;
    background: white;
    z-index: 15;
    width: 30px;
    min-width: 30px;
    max-width: 30px;
}

.work-schedule-table .no-header {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    z-index: 20;
}

/* CEç•ªå·ã‚¢ã‚¤ã‚³ãƒ³ */
.work-schedule-table .ce-number {
    background: var(--brand-primary);
    color: white;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    font-weight: bold;
    margin: 0 auto;
}

/* æ—¥ä»˜åˆ—å¹…çµ±ä¸€ */
.work-schedule-table .date-col {
    width: 24px;
    min-width: 24px;
    max-width: 24px;
}
        
        /* ãƒšãƒ¼ã‚¸å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ‰åŠ¹åŒ– */
html, body {
    height: auto;
    overflow-y: auto;
}

.schedule-main { 
    overflow: visible; 
}

/* ã‚·ãƒ³ãƒ—ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.simple-header {
    margin-bottom: 20px;
}

/* å‹¤å‹™è¡¨æœŸé–“ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
.schedule-period-controls {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    text-align: center;
}

.period-display {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 8px;
    color: #1f2937;
}

.period-details {
    font-size: 12px;
    color: #666;
    margin-bottom: 12px;
}

.control-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .schedule-period-controls {
        padding: 12px;
    }
    
    .period-display {
        font-size: 16px;
    }
}
        
        /* ãƒšãƒ¼ã‚¸å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ‰åŠ¹åŒ– */
html, body {
    height: auto;
    overflow-y: auto;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Œå…¨ç„¡åŠ¹åŒ– */
.work-schedule-table-wrapper {
    overflow: visible !important;
    height: auto !important;
}

.work-schedule-table {
    overflow: visible !important;
    height: auto !important;
}
        
    </style>
</head>
<body class="theme-unified">
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading" class="center-layout">
        <div class="glass-card center-card text-center">
            <div class="spinner mb-4"></div>
            <p class="text-gray-600">å‹¤å‹™è¡¨ç®¡ç†ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ -->
    <div id="mainInterface" class="schedule-layout" style="display:none;">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div id="sidebar" class="schedule-sidebar">
            <button id="toggleSidebar" class="sidebar-toggle" title="ã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤º/éè¡¨ç¤º">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <div class="sidebar-content">
                <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="mb-6 text-center">
                    <h1 class="text-lg font-bold text-gray-800 mb-2">
                        <i class="fas fa-table mr-2 text-green-600"></i>
                        å‹¤å‹™è¡¨ç®¡ç†
                    </h1>
                    <p class="text-xs text-gray-600">CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V2</p>
                    <div class="mt-3 text-xs text-gray-600">
                        <span id="currentUserDisplay">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                    </div>
                </div>

                <!-- åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                <div class="mb-4">
                    <div id="mainSyncStatus" class="sync-indicator connected">
                        <div class="sync-dot pulse"></div>
                        <span class="text-xs">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸä¸­</span>
                    </div>
                </div>

                <!-- å‹¤å‹™è¡¨æ“ä½œ(ç®¡ç†è€…ã®ã¿) -->
                <div id="adminScheduleActions" class="mb-6" style="display:none;">
                    <h3 class="text-sm font-semibold mb-3">
                        <i class="fas fa-plus mr-2"></i>å‹¤å‹™è¡¨æ“ä½œ
                    </h3>
                    <div class="space-y-2">
                        <button id="createScheduleBtn" class="btn-unified btn-primary-unified btn-small w-full">
                            <i class="fas fa-edit mr-1"></i>å‹¤å‹™è¡¨ã‚’ä½œæˆãƒ»ç·¨é›†
                        </button>
                    </div>
                </div>

                <!-- è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿ -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold mb-3">
                        <i class="fas fa-filter mr-2"></i>è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿
                    </h3>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="radio" id="showFuture" name="timeFilter" class="mr-2" checked>
                            <label for="showFuture" class="text-xs">ä»Šå¾Œã®å‹¤å‹™è¡¨</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="showPast" name="timeFilter" class="mr-2">
                            <label for="showPast" class="text-xs">ä»¥å‰ã®å‹¤å‹™è¡¨</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="showAll" name="timeFilter" class="mr-2">
                            <label for="showAll" class="text-xs">å…¬é–‹æ¸ˆã¿å…¨ã¦</label>
                        </div>
                        <div class="flex items-center" id="adminFilterContainer" style="display:none;">
                            <input type="checkbox" id="showHidden" class="mr-2">
                            <label for="showHidden" class="text-xs">éå…¬é–‹</label>
                        </div>
                    </div>
                </div>

                <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                <div class="mt-auto pt-4 border-t border-gray-200">
                    <div class="space-y-2">
                        <a href="./home.html" class="btn-unified btn-outline-unified btn-small w-full">
                            <i class="fas fa-home mr-1"></i>HOME
                        </a>
                        <button onclick="window.handleLogout()" 
                                class="btn-unified btn-outline-unified btn-small w-full text-red-600 border-red-600">
                            <i class="fas fa-sign-out-alt mr-1"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="schedule-main">

            <!-- ã‚·ãƒ³ãƒ—ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="simple-header">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">å‹¤å‹™è¡¨ç®¡ç†</h2>
                <p class="text-gray-600">ä½œæˆæ¸ˆã¿ã®å‹¤å‹™è¡¨ã®é–²è¦§ãƒ»ç®¡ç†ã‚’è¡Œã„ã¾ã™</p>
            </div>

            <!-- å‹¤å‹™è¡¨è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="workScheduleDisplayArea">
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-table text-4xl mb-4"></i>
                    <h3 class="text-lg font-semibold mb-2">CEå‹¤å‹™è¡¨</h3>
                    <p class="mb-4">ä½œæˆæ¸ˆã¿ã®å‹¤å‹™è¡¨ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è»½é‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½
        window.showMessage = window.showMessage || function(msg, type='info') {
            let cont = document.getElementById('messageContainer');
            if (!cont) {
                cont = document.createElement('div');
                cont.id = 'messageContainer';
                cont.style.cssText = 'position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:9999;width:min(92vw,480px);';
                document.body.appendChild(cont);
            }
            const div = document.createElement('div');
            div.className = `status-unified ${type}`;
            div.style.marginBottom = '8px';
            div.textContent = msg;
            cont.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        };

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
window.handleLogout = async () => {
    try {
        // ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²(å…±é€šãƒ­ã‚¬ãƒ¼ä½¿ç”¨)
        if (window.auditLogger) {
            await window.auditLogger.logAction('logout');
        }

        if (window.auth && window.auth.currentUser) {
            await window.auth.signOut();
        }
    } catch (error) {
        console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
    } finally {
        sessionStorage.clear();
        localStorage.clear();
        window.location.href = '../index.html';
    }
};


        // å‹¤å‹™è¡¨ç®¡ç†ã‚¯ãƒ©ã‚¹
class CEScheduleManager {
    constructor() {
        this.schedules = [];
        this.currentPeriodIndex = 0;
        this.availablePeriods = [];
        this.realtimeListener = null;
        this.isInitialized = false;
        this.currentFilter = 'future';
        
        // â˜… ã“ã®éƒ¨åˆ†ã‚’è¿½åŠ  â˜…
this.footerTypes = [
    { label: 'å½“ç›´', filter: (ce, status, effectiveType) => status === 'B', target: 1 },
    { label: 'éç•ª', filter: (ce, status, effectiveType) => status === 'é', target: 1 },
    { label: 'OPE(A)', filter: (ce, status, effectiveType) => effectiveType === 'OPE' && status === 'A', target: null },
    { label: 'OPE(A1)', filter: (ce, status, effectiveType) => effectiveType === 'OPE' && status === 'A1', target: null },
    { label: 'ME', filter: (ce, status, effectiveType) => effectiveType === 'ME' && ['A', 'A1', 'B', 'é', 'å¹´', 'å‡º', 'ç ”'].includes(status), target: null },
    { label: 'HD', filter: (ce, status, effectiveType) => effectiveType === 'HD' && ['A', 'A1', 'B', 'é', 'å¹´', 'å‡º', 'ç ”'].includes(status), target: null },
    { label: 'FLEX', filter: (ce, status, effectiveType) => effectiveType === 'FLEX' && ['A', 'A1', 'B', 'é', 'å¹´', 'å‡º', 'ç ”'].includes(status), target: null }
];
    }

            async init() {
                if (this.isInitialized) return;
                this.isInitialized = true;

                try {
                    // èªè¨¼ã‚¬ãƒ¼ãƒ‰å®Ÿè¡Œ
                    const authSuccess = await AuthGuard.init();
                    if (!authSuccess) return;

                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
                    const userData = await AuthGuard.getUserData();
                    if (!userData || !userData.setupCompleted) {
                        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¸æ­£:', userData);
                        location.href = '../index.html';
                        return;
                    }

                    window.userRole = userData.role || 'viewer';
                    window.currentUserData = userData;

                    this.showInterface();
                    this.setupEventListeners();
                    await this.loadAvailablePeriods();
                    
                    console.log('âœ… å‹¤å‹™è¡¨ç®¡ç†åˆæœŸåŒ–å®Œäº†');
                } catch (error) {
                    console.error('å‹¤å‹™è¡¨ç®¡ç†åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    location.href = '../index.html';
                }
            }

            showInterface() {
                const loadingEl = document.getElementById('loading');
                const mainEl = document.getElementById('mainInterface');
                if (loadingEl) loadingEl.style.display = 'none';
                if (mainEl) mainEl.style.display = 'flex';

                this.updateUserDisplay();
                
                // ç®¡ç†è€…ã®ã¿ã®æ©Ÿèƒ½è¡¨ç¤º
                if (window.userRole === 'admin') {
                    document.getElementById('adminScheduleActions').style.display = 'block';
                    document.getElementById('adminFilterContainer').style.display = 'flex';
                }
            }

            updateUserDisplay() {
                const userData = window.currentUserData;
                if (!userData) return;
                
                const displayName = userData.displayName || userData.username || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                document.querySelectorAll('#currentUserDisplay').forEach(el => {
                    el.textContent = displayName;
                });
            }

            setupEventListeners() {
                // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ«
                const toggle = document.getElementById('toggleSidebar');
                const sidebar = document.getElementById('sidebar');
                
                if (toggle && sidebar) {
                    let isCollapsed = false;
                    toggle.onclick = () => {
                        isCollapsed = !isCollapsed;
                        if (isCollapsed) {
                            sidebar.classList.add('collapsed');
                            toggle.querySelector('i').className = 'fas fa-chevron-right';
                        } else {
                            sidebar.classList.remove('collapsed');
                            toggle.querySelector('i').className = 'fas fa-chevron-left';
                        }
                        
                        if (window.matchMedia('(max-width: 768px)').matches) {
                            sidebar.classList.toggle('expanded');
                        }
                    };
                }

                // å‹¤å‹™è¡¨ä½œæˆ(ç®¡ç†è€…ã®ã¿)
                const createBtn = document.getElementById('createScheduleBtn');
                if (createBtn) {
                    createBtn.onclick = () => this.openScheduleEditor();
                }

                // æœŸé–“ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
                const prevBtn = document.getElementById('prevPeriodBtn');
                const nextBtn = document.getElementById('nextPeriodBtn');
                
                // ä¿®æ­£: ã€Œå‰ã®æœŸé–“ã€ã¯å¤ã„æœŸé–“(+1)ã€ã€Œæ¬¡ã®æœŸé–“ã€ã¯æ–°ã—ã„æœŸé–“(-1)
                if (prevBtn) prevBtn.onclick = () => this.navigatePeriod(1);
                if (nextBtn) nextBtn.onclick = () => this.navigatePeriod(-1);

                // ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´
                ['showFuture', 'showPast', 'showAll', 'showHidden'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.onchange = () => this.applyFilters();
                    }
                });

                // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´(ãƒªã‚µã‚¤ã‚ºæ™‚)
                let resizeTimer = null;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        if (this.isInitialized) this.fitTableToViewport();
                    }, 250);
                });

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
                this.setupRealtimeUpdates();
            }

            setupRealtimeUpdates() {
                try {
                    if (this.realtimeListener) {
                        this.realtimeListener.off();
                    }
                    
                    this.realtimeListener = window.database.ref(`${window.DATA_ROOT}/workSchedules`);
                    this.realtimeListener.on('value', async () => {
                        console.log('ğŸ”„ å…¬é–‹å‹¤å‹™è¡¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ¤œçŸ¥');
                        await this.loadAvailablePeriods();
                        this.displayCurrentPeriod();
                    });
                } catch (error) {
                    console.warn('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°è¨­å®šå¤±æ•—:', error);
                }
            }

            async loadAvailablePeriods() {
                try {
                    const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules`).once('value');
                    const data = snapshot.val() || {};
                    
                    const today = new Date().toISOString().slice(0, 10);
                    
                    this.availablePeriods = Object.keys(data)
                        .map(periodKey => ({
                            key: periodKey,
                            ...data[periodKey].metadata
                        }))
                        .filter(period => {
                            // ç®¡ç†è€…ä»¥å¤–ã¯éå…¬é–‹ã‚’é™¤å¤–
                            if (window.userRole !== 'admin' && period.isVisible === false) {
                                return false;
                            }
                            
                            // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
                            return this.applyTimeFilter(period, today);
                        })
                        .sort((a, b) => (b.publishedAt || b.createdAt || 0) - (a.publishedAt || a.createdAt || 0));
                    
                    if (this.availablePeriods.length > 0) {
                        if (this.currentPeriodIndex >= this.availablePeriods.length) {
                            this.currentPeriodIndex = 0;
                        }
                        this.displayCurrentPeriod();
                    } else {
                        this.displayNoPeriods();
                    }
                    
                    console.log(`âœ… å…¬é–‹å‹¤å‹™è¡¨èª­ã¿è¾¼ã¿å®Œäº†: ${this.availablePeriods.length}ä»¶`);
                } catch (error) {
                    console.error('âŒ æœŸé–“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    window.showMessage('å‹¤å‹™è¡¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }

            applyTimeFilter(period, today) {
                const showFuture = document.getElementById('showFuture')?.checked;
                const showPast = document.getElementById('showPast')?.checked;
                const showAll = document.getElementById('showAll')?.checked;
                
                if (showAll) {
                    return true;
                }
                
                if (showFuture) {
                    return period.endDate >= today; // ä»Šæ—¥ã‚’å«ã‚€ä»¥é™
                }
                
                if (showPast) {
                    return period.endDate < today; // ä»Šæ—¥ã‚’å«ã¾ãªã„ä»¥å‰
                }
                
                return true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            }

            applyFilters() {
                this.loadAvailablePeriods();
            }

            navigatePeriod(direction) {
                const newIndex = this.currentPeriodIndex + direction;
                
                if (newIndex < 0 || newIndex >= this.availablePeriods.length) {
                    window.showMessage('ã“ã‚Œä»¥ä¸Šã®æœŸé–“ã¯ã‚ã‚Šã¾ã›ã‚“', 'info');
                    return;
                }
                
                this.currentPeriodIndex = newIndex;
                this.displayCurrentPeriod();
            }

            async displayCurrentPeriod() {
                if (this.availablePeriods.length === 0) {
                    this.displayNoPeriods();
                    return;
                }

                const currentPeriod = this.availablePeriods[this.currentPeriodIndex];
                await this.renderWorkScheduleTable(currentPeriod.key);
            }
            
            reattachPeriodControls() {
                // æœŸé–“ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
                const prevBtn = document.getElementById('prevPeriodBtn');
                const nextBtn = document.getElementById('nextPeriodBtn');
                
                if (prevBtn) prevBtn.onclick = () => this.navigatePeriod(1);
                if (nextBtn) nextBtn.onclick = () => this.navigatePeriod(-1);
                
                // ç®¡ç†è€…ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¡¨ç¤º
                const adminControlsEl = document.getElementById('adminControlsContainer');
                if (adminControlsEl && window.userRole === 'admin') {
                    const currentPeriod = this.availablePeriods[this.currentPeriodIndex];
                    adminControlsEl.innerHTML = this.renderAdminControls(currentPeriod);
                    adminControlsEl.style.display = 'inline-flex';
                    adminControlsEl.style.gap = '8px';
                }
            }

            renderAdminControls(period) {
                return `
                    <button onclick="window.ceScheduleManager.toggleVisibility('${period.key}')" 
                            class="btn-unified btn-small ${period.isVisible === false ? 'btn-success' : 'btn-warning'}" 
                            title="è¡¨ç¤º/éè¡¨ç¤ºåˆ‡æ›¿">
                        <i class="fas fa-eye${period.isVisible === false ? '' : '-slash'}"></i>
                        ${period.isVisible === false ? 'å…¬é–‹' : 'éå…¬é–‹'}
                    </button>
                    <button onclick="window.ceScheduleManager.deleteSchedule('${period.key}')" 
                            class="btn-unified btn-small btn-danger" title="å‰Šé™¤">
                        <i class="fas fa-trash"></i>å‰Šé™¤
                    </button>
                `;
            }

            displayNoPeriods() {
                const displayEl = document.getElementById('currentPeriodDisplay');
                const detailsEl = document.getElementById('periodDetails');
                const areaEl = document.getElementById('workScheduleDisplayArea');
                const adminControlsEl = document.getElementById('adminControlsContainer');
                
                if (displayEl) displayEl.textContent = 'è©²å½“ã™ã‚‹å‹¤å‹™è¡¨ãªã—';
                if (detailsEl) detailsEl.textContent = '';
                if (areaEl) {
                    const createButton = window.userRole === 'admin' ? 
                        `<button onclick="window.ceScheduleManager.openScheduleEditor()" 
                                class="btn-unified btn-primary-unified">
                            <i class="fas fa-plus mr-2"></i>æœ€åˆã®å‹¤å‹™è¡¨ã‚’ä½œæˆ
                        </button>` : '';
                    
                    areaEl.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-calendar-plus text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-600 mb-2">CEå‹¤å‹™è¡¨</h3>
                            <p class="text-gray-500 mb-4">è©²å½“ã™ã‚‹å‹¤å‹™è¡¨ãŒã‚ã‚Šã¾ã›ã‚“</p>
                            ${createButton}
                        </div>
                    `;
                }
                if (adminControlsEl) adminControlsEl.style.display = 'none';
            }

            async renderWorkScheduleTable(periodKey) {
                const areaEl = document.getElementById('workScheduleDisplayArea');
                if (!areaEl) return;

                try {
                    const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}`).once('value');
                    const periodData = snapshot.val();
                    
                    if (!periodData || !periodData.ceList) {
                        areaEl.innerHTML = `
                            <div class="text-center py-8">
                                <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                                <p class="text-gray-600">å‹¤å‹™è¡¨ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯CEãƒªã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
                            </div>
                        `;
                        return;
                    }

                    const scheduleData = periodData.scheduleData || {};
                    const ceList = periodData.ceList;
                    const workTypeOverrides = periodData.workTypeOverrides || {};
                    const dateOverrides = periodData.dateOverrides || {};  // â† ã“ã®è¡Œã‚’è¿½åŠ 
                    const metadata = periodData.metadata || {};
                    const dates = this.generateDateRange(new Date(metadata.startDate), new Date(metadata.endDate));

                    // æœŸé–“ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨å‹¤å‹™è¡¨ã‚’è¡¨ç¤º
                    const visibilityStatus = metadata.isVisible === false ? ' <span style="color:#ef4444;">(éå…¬é–‹)</span>' : '';
                    areaEl.innerHTML = `
                        <div class="schedule-period-controls">
                            <div id="currentPeriodDisplay" class="period-display">${metadata.startDate} ï½ ${metadata.endDate}${visibilityStatus}</div>
                            <div id="periodDetails" class="period-details">
                                (${this.currentPeriodIndex + 1}/${this.availablePeriods.length})
                                ${metadata.publishedBy ? ` / ä½œæˆè€…: ${metadata.publishedBy}` : ''}
                                ${metadata.publishedAt ? ` / å…¬é–‹: ${new Date(metadata.publishedAt).toLocaleString('ja-JP')}` : ''}
                            </div>
                            <div class="control-buttons">
                                <button id="prevPeriodBtn" class="btn-unified btn-outline-unified btn-small">
                                    <i class="fas fa-chevron-left mr-1"></i>å‰ã®æœŸé–“
                                </button>
                                <button id="nextPeriodBtn" class="btn-unified btn-outline-unified btn-small">
                                    æ¬¡ã®æœŸé–“<i class="fas fa-chevron-right ml-1"></i>
                                </button>
                                <span id="adminControlsContainer" style="display:none;">
                                    <!-- ç®¡ç†è€…æ“ä½œãƒœã‚¿ãƒ³ãŒã“ã“ã«è¡¨ç¤º -->
                                </span>
                            </div>
                        </div>
                        <div class="work-schedule-table-wrapper">
                            <table class="work-schedule-table">
                            ${this.generateTableHTML(dates, scheduleData, ceList, workTypeOverrides, dateOverrides)}
                            </table>
                        </div>
                    `;
                    
                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
                    this.reattachPeriodControls();

                } catch (error) {
                    console.error('âŒ å‹¤å‹™è¡¨è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                    areaEl.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                            <p class="text-gray-600">å‹¤å‹™è¡¨ã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
                        </div>
                    `;
                }
            }

            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”»é¢ã«ãƒ•ã‚£ãƒƒãƒˆ
            // ãƒ†ãƒ¼ãƒ–ãƒ«æœ€é©è¡¨ç¤º(å®Œå…¨ä¿®æ­£ç‰ˆ)
fitTableToViewport() {
    const table = document.querySelector('.work-schedule-table');
    if (!table) return;
    
    // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’ç„¡åŠ¹åŒ–ã—ã¦å®Ÿå¯¸è¡¨ç¤º
    table.style.transform = 'none';
    table.style.fontSize = '9px';
    
    console.log('ğŸ“ ãƒ†ãƒ¼ãƒ–ãƒ«å®Ÿå¯¸è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰');
}

            generateDateRange(startDate, endDate) {
                const dates = [];
                const current = new Date(startDate);
                
                while (current <= endDate) {
                    dates.push(new Date(current));
                    current.setDate(current.getDate() + 1);
                }
                
                return dates;
            }

            formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

             // ç¥æ—¥åˆ¤å®š(ç°¡æ˜“å®Ÿè£…)
            isJapaneseHoliday(date) {
                const holidays = new Set([
                    // 2024å¹´
                    '2024-01-01', // å…ƒæ—¥
                    '2024-01-08', // æˆäººã®æ—¥
                    '2024-02-11', // å»ºå›½è¨˜å¿µã®æ—¥
                    '2024-02-12', // æŒ¯æ›¿ä¼‘æ—¥
                    '2024-02-23', // å¤©çš‡èª•ç”Ÿæ—¥
                    '2024-03-20', // æ˜¥åˆ†ã®æ—¥
                    '2024-04-29', // æ˜­å’Œã®æ—¥
                    '2024-05-03', // æ†²æ³•è¨˜å¿µæ—¥
                    '2024-05-04', // ã¿ã©ã‚Šã®æ—¥
                    '2024-05-05', // ã“ã©ã‚‚ã®æ—¥
                    '2024-05-06', // æŒ¯æ›¿ä¼‘æ—¥
                    '2024-07-15', // æµ·ã®æ—¥
                    '2024-08-11', // å±±ã®æ—¥
                    '2024-08-12', // æŒ¯æ›¿ä¼‘æ—¥
                    '2024-09-16', // æ•¬è€ã®æ—¥
                    '2024-09-22', // ç§‹åˆ†ã®æ—¥
                    '2024-09-23', // æŒ¯æ›¿ä¼‘æ—¥
                    '2024-10-14', // ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥
                    '2024-11-03', // æ–‡åŒ–ã®æ—¥
                    '2024-11-04', // æŒ¯æ›¿ä¼‘æ—¥
                    '2024-11-23', // å‹¤åŠ´æ„Ÿè¬ã®æ—¥
                    
                    // 2025å¹´
                    '2025-01-01', // å…ƒæ—¥
                    '2025-01-13', // æˆäººã®æ—¥
                    '2025-02-11', // å»ºå›½è¨˜å¿µã®æ—¥
                    '2025-02-23', // å¤©çš‡èª•ç”Ÿæ—¥
                    '2025-02-24', // æŒ¯æ›¿ä¼‘æ—¥
                    '2025-03-20', // æ˜¥åˆ†ã®æ—¥
                    '2025-04-29', // æ˜­å’Œã®æ—¥
                    '2025-05-03', // æ†²æ³•è¨˜å¿µæ—¥
                    '2025-05-04', // ã¿ã©ã‚Šã®æ—¥
                    '2025-05-05', // ã“ã©ã‚‚ã®æ—¥
                    '2025-05-06', // æŒ¯æ›¿ä¼‘æ—¥
                    '2025-07-21', // æµ·ã®æ—¥
                    '2025-08-11', // å±±ã®æ—¥
                    '2025-09-15', // æ•¬è€ã®æ—¥
                    '2025-09-23', // ç§‹åˆ†ã®æ—¥
                    '2025-10-13', // ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥
                    '2025-11-03', // æ–‡åŒ–ã®æ—¥
                    '2025-11-23', // å‹¤åŠ´æ„Ÿè¬ã®æ—¥
                    '2025-11-24', // æŒ¯æ›¿ä¼‘æ—¥
                    
                    // 2026å¹´
                    '2026-01-01', // å…ƒæ—¥
                    '2026-01-12', // æˆäººã®æ—¥
                    '2026-02-11', // å»ºå›½è¨˜å¿µã®æ—¥
                    '2026-02-23', // å¤©çš‡èª•ç”Ÿæ—¥
                    '2026-03-20', // æ˜¥åˆ†ã®æ—¥
                    '2026-04-29', // æ˜­å’Œã®æ—¥
                    '2026-05-03', // æ†²æ³•è¨˜å¿µæ—¥
                    '2026-05-04', // ã¿ã©ã‚Šã®æ—¥
                    '2026-05-05', // ã“ã©ã‚‚ã®æ—¥
                    '2026-05-06', // æŒ¯æ›¿ä¼‘æ—¥
                    '2026-07-20', // æµ·ã®æ—¥
                    '2026-08-11', // å±±ã®æ—¥
                    '2026-09-21', // æ•¬è€ã®æ—¥
                    '2026-09-22', // å›½æ°‘ã®ä¼‘æ—¥
                    '2026-09-23', // ç§‹åˆ†ã®æ—¥
                    '2026-10-12', // ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥
                    '2026-11-03', // æ–‡åŒ–ã®æ—¥
                    '2026-11-23'  // å‹¤åŠ´æ„Ÿè¬ã®æ—¥
                ]);

                const dateKey = this.formatDate(date);
                return holidays.has(dateKey);
            }

            getEffectiveWorkType(ceId, dateKey, ceList, workTypeOverrides) {
                const ce = ceList.find(c => c.id === ceId);
                if (!ce) return 'ME';

                const overrides = workTypeOverrides[ceId];
                if (Array.isArray(overrides)) {
                    const validOverrides = overrides
                        .filter(override => dateKey >= override.startDate && dateKey <= override.endDate)
                        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    
                    if (validOverrides.length > 0) {
                        return validOverrides[0].workType;
                    }
                } else if (overrides && overrides.startDate && dateKey >= overrides.startDate && dateKey <= overrides.endDate) {
                    return overrides.workType;
                }
                
                return ce.workType || 'ME';
            }

            generateTableHTML(dates, scheduleData, ceList, workTypeOverrides, dateOverrides = {}) {
               // æ—¥ä»˜ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å¯¾å¿œã®ä¼‘æ—¥åˆ¤å®š
                const isWeekendOrHolidayWithOverride = (date) => {
                    const dateKey = this.formatDate(date);
                    
                    // ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å„ªå…ˆ
                    if (dateOverrides[dateKey] === 'holiday') {
                        return true;
                    }
                    if (dateOverrides[dateKey] === 'workday') {
                        return false;
                    }
                    
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åˆ¤å®š
                    return date.getDay() === 0 || date.getDay() === 6 || this.isJapaneseHoliday(date);
                };
                
    // ãƒ˜ãƒƒãƒ€ãƒ¼(No + æ°å)
    let html = '<thead><tr><th class="no-header">No</th><th class="name-header">æ°å</th>';
    
    dates.forEach(date => {
        const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
        const isHoliday = this.isJapaneseHoliday(date);
        let headerClass = '';
        if (date.getDay() === 0 || isHoliday) headerClass = 'text-red-600';
        else if (date.getDay() === 6) headerClass = 'text-blue-600';
        
        html += `<th class="date-col"><div>${date.getDate()}</div><div class="text-xs ${headerClass}">${dayOfWeek}</div></th>`;
    });
    
    const summaryHeaders = ['A', 'A1', 'B', 'é', 'Ã—', 'ä¼‘æ—¥æ•°', 'å®Ÿå‹¤å‹™', 'å½“ç›´å›æ•°'];
    summaryHeaders.forEach(h => html += `<th class="summary-cell">${h}</th>`);
    html += '</tr></thead><tbody>';
    
    ceList.forEach((ce, index) => {
        const fullName = ce.fullName || ce.name || '';
        html += `<tr><td class="no-cell"><div class="ce-number">${index + 1}</div></td><td class="name-cell"><div class="font-medium">${fullName}</div></td>`;
        
        const summary = { A: 0, A1: 0, B: 0, non: 0, off: 0, holidays: 0, actual: 0, night: 0 };
        
        dates.forEach(date => {
            const dateKey = this.formatDate(date);
            const workData = scheduleData[ce.id]?.[dateKey] || {};
            const isWeekendOrHoliday = isWeekendOrHolidayWithOverride(date);
            
            // ãƒ†ã‚­ã‚¹ãƒˆå„ªå…ˆè¡¨ç¤ºã®ä¿®æ­£
            const displayStatus = workData.customText?.trim() || workData.status || (isWeekendOrHoliday ? 'Ã—' : 'A');
            
            if (isWeekendOrHoliday) summary.holidays++;
            switch (workData.status || (isWeekendOrHoliday ? 'Ã—' : 'A')) {
                case 'A': summary.A++; summary.actual++; break;
                case 'A1': summary.A1++; summary.actual++; break;
                case 'B': summary.B++; summary.actual++; summary.night++; break;
                case 'é': summary.non++; summary.actual++; break;
                case 'Ã—': summary.off++; break;
                case 'å¹´': summary.actual++; break;
                case 'å‡º': summary.actual++; break;
                case 'ç ”': summary.actual++; break;
            }
            
            const effectiveWorkType = this.getEffectiveWorkType(ce.id, dateKey, ceList, workTypeOverrides);
            let cellClass = `work-cell date-col type-${effectiveWorkType.toLowerCase()}`;
            
            if (workData.status) {
                cellClass += ` status-${workData.status}`;
            }
            if (workData.customText?.trim()) {
                cellClass += ' status-text';
            }
            if (workData.desired) {
                cellClass += ' desired';
            }
            if (isWeekendOrHoliday) {
                cellClass += ' holiday';
            }
            
            html += `<td class="${cellClass}">${displayStatus}</td>`;
        });
        
        [summary.A, summary.A1, summary.B, summary.non, summary.off, summary.holidays, summary.actual, summary.night].forEach(v => {
            html += `<td class="summary-cell">${v}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody><tfoot>';
    this.footerTypes.forEach(type => {
        html += `<tr class="footer-summary-row"><th class="type-label" colspan="2">${type.label}</th>`;
        
        dates.forEach(date => {
            const dateKey = this.formatDate(date);
            let count = 0;
            ceList.forEach(ce => {
                const workData = scheduleData[ce.id]?.[dateKey] || {};
                const isWeekendOrHoliday = isWeekendOrHolidayWithOverride(date);
                const status = workData.status || (isWeekendOrHoliday ? 'Ã—' : 'A');
                const effectiveType = this.getEffectiveWorkType(ce.id, dateKey, ceList, workTypeOverrides);
                if (type.filter(ce, status, effectiveType)) count++;
            });
            const warn = (type.target !== null && count !== type.target) ? 'warning-count' : '';
            html += `<td class="date-col ${warn}">${count}</td>`;
        });
        
        summaryHeaders.forEach(() => html += '<td class="summary-cell"></td>');
        html += '</tr>';
    });
    
    return html + '</tfoot>';
}

            async toggleVisibility(periodKey) {
                if (window.userRole !== 'admin') {
                    window.showMessage('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™', 'warning');
                    return;
                }

                try {
                    const snapshot = await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}/metadata`).once('value');
                    const metadata = snapshot.val();
                    
                    const newVisibility = !(metadata?.isVisible !== false);
                    await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}/metadata/isVisible`).set(newVisibility);
                    
                    window.showMessage(`å‹¤å‹™è¡¨ã‚’${newVisibility ? 'è¡¨ç¤º' : 'éè¡¨ç¤º'}ã«è¨­å®šã—ã¾ã—ãŸ`, 'success');
                    
                    await this.loadAvailablePeriods();
                    
                } catch (error) {
                    console.error('âŒ è¡¨ç¤ºåˆ‡æ›¿ã‚¨ãƒ©ãƒ¼:', error);
                    window.showMessage('è¡¨ç¤ºè¨­å®šã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }

            async deleteSchedule(periodKey) {
                if (window.userRole !== 'admin') {
                    window.showMessage('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™', 'warning');
                    return;
                }

                const period = this.availablePeriods.find(p => p.key === periodKey);
                if (!period) return;

                if (!confirm(`å‹¤å‹™è¡¨ã€Œ${period.startDate} ï½ ${period.endDate}ã€ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹?\n\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                    return;
                }

                try {
                    await window.database.ref(`${window.DATA_ROOT}/workSchedules/${periodKey}`).remove();
                    window.showMessage('å‹¤å‹™è¡¨ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                    
                    await this.loadAvailablePeriods();
                    
                } catch (error) {
                    console.error('âŒ å‹¤å‹™è¡¨å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    window.showMessage('å‹¤å‹™è¡¨ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }

            openScheduleEditor() {
                if (window.userRole !== 'admin') {
                    window.showMessage('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™', 'warning');
                    return;
                }
                
                const targetUID = sessionStorage.getItem('targetUID');
                const currentUsername = sessionStorage.getItem('currentUsername');
                
                if (!targetUID || !currentUsername) {
                    window.showMessage('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
                    return;
                }
                
                const params = new URLSearchParams({
                    uid: targetUID,
                    username: currentUsername,
                    role: window.userRole,
                    timestamp: Date.now()
                });
                
                const url = `work-schedule-editor.html?${params.toString()}`;
                
                const win = window.open(url, 'workScheduleEditor', 'width=1400,height=900,scrollbars=yes,resizable=yes');
                
                if (!win || win.closed || typeof win.closed === 'undefined') {
                    if (confirm('æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚åŒã˜ã‚¿ãƒ–ã§å‹¤å‹™è¡¨ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ãã¾ã™ã‹?')) {
                        window.location.href = url;
                    } else {
                        window.showMessage('å‹¤å‹™è¡¨ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ãã«ã¯ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„', 'warning');
                    }
                } else {
                    console.log('âœ… å‹¤å‹™è¡¨ã‚¨ãƒ‡ã‚£ã‚¿ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã—ãŸ');
                }
            }
        }

        // åˆæœŸåŒ–
        window.ceScheduleManager = null;
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                window.ceScheduleManager = new CEScheduleManager();
                await window.ceScheduleManager.init();
                if (window.auditLogger) {
    await window.auditLogger.logPageAccess('ce-schedule');
}
                console.log('âœ… å‹¤å‹™è¡¨ç®¡ç†åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('âŒ å‹¤å‹™è¡¨ç®¡ç†åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                window.showMessage('å‹¤å‹™è¡¨ç®¡ç†ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        });
    </script>
</body>
</html>
