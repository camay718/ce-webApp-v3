<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººè¨­å®š - CE web App v3</title>
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- çµ±ä¸€ãƒ†ãƒ¼ãƒ -->
    <link rel="stylesheet" href="../css/theme-unified.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Firebaseè¨­å®šãƒ•ã‚¡ã‚¤ãƒ« -->
    <script src="../js/config/firebase-config.js"></script>
    <script src="../js/ui/theme-switcher.js"></script>
    
    <style>
        .center-layout {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .center-card {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        /* ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
            gap: 8px;
        }
        
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #d1d5db;
            transition: all 0.3s ease;
        }
        
        .step-dot.active {
            background-color: #10b981;
            transform: scale(1.2);
        }
        
        .step-dot.completed {
            background-color: #6ee7b7;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¨®åˆ¥é¸æŠãƒœã‚¿ãƒ³ */
        .user-type-btn {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        
        .user-type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .user-type-btn.selected {
            border-color: #10b981;
            background-color: #ecfdf5;
        }

        /* CEé¸æŠã‚°ãƒªãƒƒãƒ‰ */
        .ce-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .ce-option {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .ce-option:hover {
            background-color: #f3f4f6;
            border-color: #10b981;
        }
        
        .ce-option.selected {
            background-color: #ecfdf5;
            border-color: #10b981;
            font-weight: 600;
        }
        
        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å¯¾å¿œ */
        @media (max-width: 768px) {
            .center-layout {
                padding: 16px;
                align-items: flex-start;
                padding-top: 40px;
            }
            .glass-card { padding: 20px !important; }
            h1 { font-size: 1.8rem !important; }
            .input-unified { font-size: 16px; padding: 12px; }
            .btn-unified { padding: 14px 20px; font-size: 14px; }
            .ce-select-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
        }
        
        @media (max-width: 480px) {
            .center-layout {
                padding: 12px;
                padding-top: 20px;
            }
            .glass-card { padding: 16px !important; }
            h1 { font-size: 1.5rem !important; }
        }
    </style>
</head>
<body class="theme-unified">
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loadingScreen" class="center-layout">
        <div class="glass-card center-card text-center">
            <div class="spinner mb-4"></div>
            <h2 class="text-xl font-semibold text-gray-700">èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...</h2>
            <p class="text-gray-500 mt-2">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div id="mainContent" class="center-layout" style="display: none;">
        <div class="glass-card center-card">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="text-center mb-8">
                <div class="bg-gradient-to-br from-green-100 to-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fas fa-user-cog text-green-600 text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">å€‹äººè¨­å®š</h1>
                <p class="text-gray-600">CE web App</p>
                <div class="mt-4 text-right">
                    <div class="text-sm text-gray-500">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</div>
                    <div id="currentUser" class="font-semibold text-gray-800">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
            <div class="step-indicator">
                <div class="step-dot active" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
            </div>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="statusMessage" class="status-unified mb-6" style="display: none;"></div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¨®åˆ¥é¸æŠ -->
            <div id="step1UserType" class="step-content">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-user-tag text-green-600 mr-2"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¨®åˆ¥é¸æŠ
                    </h2>
                    <p class="text-gray-600 text-sm">ã‚ãªãŸã®è·ç¨®ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                </div>
                <div class="space-y-4">
                    <button class="user-type-btn w-full p-4 border-2 rounded-lg hover:bg-blue-50" data-type="ce">
                        <div class="flex items-center justify-center">
                            <i class="fas fa-user-md text-blue-600 text-2xl mr-3"></i>
                            <div class="text-left">
                                <div class="font-semibold text-lg">CEï¼ˆè‡¨åºŠå·¥å­¦æŠ€å£«ï¼‰</div>
                                <div class="text-sm text-gray-600">å‹¤å‹™å¸Œæœ›ã®æå‡ºãŒå¿…è¦ã§ã™</div>
                            </div>
                        </div>
                    </button>
                    <button class="user-type-btn w-full p-4 border-2 rounded-lg hover:bg-gray-50" data-type="manager">
                        <div class="flex items-center justify-center">
                            <i class="fas fa-user-tie text-gray-600 text-2xl mr-3"></i>
                            <div class="text-left">
                                <div class="font-semibold text-lg">ç®¡ç†è·ï¼ˆã‚»ãƒ³ã‚¿ãƒ¼é•·ãƒ»å‰¯ã‚»ãƒ³ã‚¿ãƒ¼é•·ç­‰ï¼‰</div>
                                <div class="text-sm text-gray-600">å‹¤å‹™å¸Œæœ›ã®æå‡ºã¯ä¸è¦ã§ã™</div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—2: CEé¸æŠ -->
            <div id="step2CESelection" class="step-content" style="display: none;">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-user-check text-green-600 mr-2"></i>CEé¸æŠ
                    </h2>
                    <p class="text-gray-600 text-sm">CEãƒªã‚¹ãƒˆã‹ã‚‰è‡ªåˆ†ã®åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                </div>
                <div id="ceSelectGrid" class="ce-select-grid mb-6"></div>
                <div class="flex justify-between">
                    <button id="backToStep1Btn" class="btn-unified btn-outline-unified">
                        <i class="fas fa-arrow-left mr-2"></i>æˆ»ã‚‹
                    </button>
                    <button id="continueToStep3Btn" class="btn-unified btn-primary-unified" disabled>
                        æ¬¡ã¸<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š -->
            <div id="step3ProfileSetup" class="step-content" style="display: none;">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-id-card text-green-600 mr-2"></i>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š
                    </h2>
                    <p class="text-gray-600 text-sm">å€‹äººæƒ…å ±ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„</p>
                </div>

                <form id="setupForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">
                            <i class="fas fa-user text-green-600 mr-2"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼å
                        </label>
                        <div id="usernameDisplay" class="input-unified bg-gray-50 cursor-not-allowed">èª­ã¿è¾¼ã¿ä¸­...</div>
                        <p class="text-xs text-gray-500 mt-1">â€»ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯å¤‰æ›´ã§ãã¾ã›ã‚“</p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">
                            <i class="fas fa-user-tag text-green-600 mr-2"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¨®åˆ¥
                        </label>
                        <div id="userTypeDisplay" class="input-unified bg-gray-50 cursor-not-allowed">æœªé¸æŠ</div>
                    </div>

                    <div id="ceSelectionDisplaySection" style="display: none;">
                        <label class="block text-sm font-bold mb-2 text-gray-700">
                            <i class="fas fa-user-md text-green-600 mr-2"></i>ç´ä»˜ã‘CE
                        </label>
                        <div id="ceSelectionDisplay" class="input-unified bg-blue-50 cursor-not-allowed font-semibold">æœªé¸æŠ</div>
                        <p class="text-xs text-blue-600 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>ã“ã®CEã¨ã—ã¦å‹¤å‹™å¸Œæœ›ã‚’æå‡ºã—ã¾ã™
                        </p>
                    </div>

                    <div>
                        <label for="displayNameInput" class="block text-sm font-bold mb-2 text-gray-700">
                            <i class="fas fa-id-card text-green-600 mr-2"></i>è¡¨ç¤ºå
                        </label>
                        <input type="text" id="displayNameInput" class="input-unified" placeholder="ç”»é¢ã«è¡¨ç¤ºã™ã‚‹åå‰ã‚’å…¥åŠ›" autocomplete="name">
                        <p class="text-xs text-gray-500 mt-1">â€»ã‚·ã‚¹ãƒ†ãƒ å†…ã§ã®è¡¨ç¤ºåã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™</p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">
                            <i class="fas fa-shield text-green-600 mr-2"></i>æ¨©é™ãƒ¬ãƒ™ãƒ«
                        </label>
                        <div id="roleDisplay" class="input-unified bg-gray-50 cursor-not-allowed">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>

                    <div>
                        <label for="newPassword" class="block text-sm font-bold mb-2 text-gray-700">
                            <i class="fas fa-lock text-green-600 mr-2"></i>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *
                        </label>
                        <div class="relative">
                            <input type="password" id="newPassword" class="input-unified pr-12" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" required autocomplete="new-password">
                            <button type="button" onclick="togglePassword('newPassword')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="passwordStrength" class="text-xs mt-2"></div>
                    </div>

                    <div>
                        <label for="confirmPassword" class="block text-sm font-bold mb-2 text-gray-700">
                            <i class="fas fa-lock text-green-600 mr-2"></i>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª *
                        </label>
                        <div class="relative">
                            <input type="password" id="confirmPassword" class="input-unified pr-12" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›" required autocomplete="new-password">
                            <button type="button" onclick="togglePassword('confirmPassword')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="passwordMatch" class="text-xs mt-2"></div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="backToStep2Btn" class="btn-unified btn-outline-unified">
                            <i class="fas fa-arrow-left mr-2"></i>æˆ»ã‚‹
                        </button>
                        <button type="submit" id="saveButton" class="btn-unified btn-primary-unified">
                            <i class="fas fa-save mr-2"></i>è¨­å®šã‚’ä¿å­˜ã—ã¦HOMEã¸
                        </button>
                    </div>
                </form>

                <div class="text-center mt-6">
                    <button onclick="logout()" class="btn-unified btn-outline-unified w-full">
                        <i class="fas fa-sign-out-alt mr-2"></i>ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é˜²å¾¡çš„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ 
        window.showMessage = function(msg, type='info') {
            const statusDiv = document.getElementById('statusMessage');
            if (statusDiv) {
                statusDiv.className = `status-unified ${type}`;
                statusDiv.textContent = msg;
                statusDiv.style.display = 'block';
                setTimeout(() => statusDiv.style.display = 'none', 5000);
            } else {
                console.log(`[${type.toUpperCase()}] ${msg}`);
                alert(msg);
            }
        };

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let auth, database;
        let currentUserData = null;
        let isProcessing = false;
        let selectedUserType = null;
        let selectedCEId = null;
        let selectedCEName = null;
        let ceList = [];
        let currentStep = 1;

        // å®‰å…¨ãªDOMæ“ä½œé–¢æ•°
        function safeSetText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
                return true;
            } else {
                console.warn(`è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${elementId}`);
                return false;
            }
        }

        function safeSetValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (element && 'value' in element) {
                element.value = value;
                return true;
            } else {
                console.warn(`å…¥åŠ›è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${elementId}`);
                return false;
            }
        }

        // ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†
        function updateStepIndicator() {
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                const stepNum = index + 1;
                dot.classList.remove('active', 'completed');
                if (stepNum < currentStep) {
                    dot.classList.add('completed');
                } else if (stepNum === currentStep) {
                    dot.classList.add('active');
                }
            });
        }

        function showStep(stepNum) {
            document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
            const stepElements = { 1: 'step1UserType', 2: 'step2CESelection', 3: 'step3ProfileSetup' };
            const stepElement = document.getElementById(stepElements[stepNum]);
            if (stepElement) {
                stepElement.style.display = 'block';
                currentStep = stepNum;
                updateStepIndicator();
            } else {
                console.error(`ã‚¹ãƒ†ãƒƒãƒ—è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${stepNum}`);
            }
        }

        // CEãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
        async function loadCEList() {
            try {
                const dataRoot = window.DATA_ROOT || 'ceSchedulev3';
                const snapshot = await database.ref(`${dataRoot}/ceList`).once('value');
                const data = snapshot.val();
                
                if (data && data.list && Array.isArray(data.list)) {
                    ceList = data.list;
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®27åãƒªã‚¹ãƒˆ
                    ceList = [
                        'å®‰å­«å­æ˜åš', 'å…«é¬ç´”', 'æ‰å±±é™½å­', 'ä¸­æ‘åœ­ä½‘', 'çŸ³å±±æ™ºä¹‹', 'äº€äº•ç¥å“‰', 'ä¸¸è—¤å¥', 'ä¸‰æ˜¥æ‘©å¼¥', 'æ–è—¤å¤§æ¨¹', 'ç”°ä¸­éš†æ˜­',
                        'å®‡äº•å‹‡æ°—', 'å®‡é‡æ²¢å¾¹', 'ä½è—¤å°†å¿—', 'åº„å¸ç”±ç´€', 'å°æ²¼å’Œæ¨¹', 'æ­¦ç”°å„ªæ–—', 'è¨­æ¨‚ä½‘ä»‹', 'ä¼Šè—¤å¤§æ™Ÿ', 'ä¸Šæ¾é‡è–', 'ç¬¹ç”Ÿè²´ä¹‹',
                        'å’Œç”°å½©èŠ±', 'ä¼Šè—¤å¤§ç¨€', 'ä½è—¤åƒå„ª', 'æ¡‘å³¶äºœä¾', 'æ‘ç”°ä¸ƒæ˜Ÿ', 'å°æ—å°†å·±', 'å¯’æ²³æ±Ÿæ‚ è¼'
                    ].map((name, index) => ({
                        id: `ce${index + 1}`,
                        fullName: name,
                        iconName: name.substring(0, 2),
                        workType: index < 8 ? 'OPE' : index < 16 ? 'ME' : index < 22 ? 'HD' : 'FLEX'
                    }));
                }
                console.log('âœ… CEãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº†:', ceList.length + 'å');
                renderCESelection();
            } catch (error) {
                console.error('âŒ CEãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('CEãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        function renderCESelection() {
            const grid = document.getElementById('ceSelectGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            ceList.forEach(ce => {
                const option = document.createElement('div');
                option.className = 'ce-option';
                option.innerHTML = `
                    <div class="font-semibold text-sm">${ce.fullName}</div>
                    <div class="text-xs text-gray-500 mt-1">${ce.workType}</div>
                `;
                option.onclick = () => selectCE(ce.id, ce.fullName, option);
                grid.appendChild(option);
            });
        }

        function selectCE(ceId, ceName, element) {
            document.querySelectorAll('.ce-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedCEId = ceId;
            selectedCEName = ceName;
            const continueBtn = document.getElementById('continueToStep3Btn');
            if (continueBtn) continueBtn.disabled = false;
        }

        function updateStep3Display() {
            const ceSelectionSection = document.getElementById('ceSelectionDisplaySection');
            if (selectedUserType === 'ce') {
                safeSetText('userTypeDisplay', 'CEï¼ˆè‡¨åºŠå·¥å­¦æŠ€å£«ï¼‰');
                if (ceSelectionSection) ceSelectionSection.style.display = 'block';
                safeSetText('ceSelectionDisplay', selectedCEName || 'æœªé¸æŠ');
            } else {
                safeSetText('userTypeDisplay', 'ç®¡ç†è·ï¼ˆã‚»ãƒ³ã‚¿ãƒ¼é•·ãƒ»å‰¯ã‚»ãƒ³ã‚¿ãƒ¼é•·ç­‰ï¼‰');
                if (ceSelectionSection) ceSelectionSection.style.display = 'none';
            }
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
        function validatePassword(password) {
            const minLength = 8;
            let strength = 0;
            let feedback = [];

            if (password.length >= minLength) strength++;
            else feedback.push(`${minLength}æ–‡å­—ä»¥ä¸Š`);

            if (/[A-Z]/.test(password)) strength++;
            else feedback.push('å¤§æ–‡å­—');

            if (/[a-z]/.test(password)) strength++;
            else feedback.push('å°æ–‡å­—');

            if (/\d/.test(password)) strength++;
            else feedback.push('æ•°å­—');

            if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength++;
            else feedback.push('ç‰¹æ®Šæ–‡å­—');

            return { strength, feedback, isValid: strength >= 4 };
        }

        function updatePasswordStrength() {
            const password = document.getElementById('newPassword')?.value || '';
            const strengthDiv = document.getElementById('passwordStrength');
            if (!strengthDiv || !password) return;

            const validation = validatePassword(password);
            const colors = ['text-red-600', 'text-orange-600', 'text-yellow-600', 'text-green-600', 'text-green-700'];
            const labels = ['å¼±ã„', 'ã‚„ã‚„å¼±ã„', 'æ™®é€š', 'å¼·ã„', 'éå¸¸ã«å¼·ã„'];

            strengthDiv.innerHTML = `
                <span class="${colors[validation.strength - 1] || 'text-red-600'}">
                    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦: ${labels[validation.strength - 1] || 'å¼±ã„'}
                </span>
                ${validation.feedback.length > 0 ? `<br>å¿…è¦ãªè¦ç´ : ${validation.feedback.join(', ')}` : ''}
            `;
        }

        function checkPasswordMatch() {
            const password = document.getElementById('newPassword')?.value || '';
            const confirm = document.getElementById('confirmPassword')?.value || '';
            const matchDiv = document.getElementById('passwordMatch');
            
            if (!matchDiv || !confirm) return false;

            const isMatch = password === confirm;
            matchDiv.innerHTML = `<span class="${isMatch ? 'text-green-600' : 'text-red-600'}">
                ${isMatch ? 'âœ“ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¦ã„ã¾ã™' : 'âœ— ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“'}
            </span>`;
            return isMatch;
        }

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            const icon = field.nextElementSibling?.querySelector('i');
            if (field.type === 'password') {
                field.type = 'text';
                if (icon) icon.className = 'fas fa-eye-slash';
            } else {
                field.type = 'password';
                if (icon) icon.className = 'fas fa-eye';
            }
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
        async function hashPasswordPBKDF2(password, iterations = 100000) {
            const enc = new TextEncoder();
            const salt = crypto.getRandomValues(new Uint8Array(16));
            
            const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits']);
            const bits = await crypto.subtle.deriveBits({ name: 'PBKDF2', salt, iterations, hash: 'SHA-256' }, keyMaterial, 256);
            
            const hashB64 = btoa(String.fromCharCode(...new Uint8Array(bits)));
            const saltB64 = btoa(String.fromCharCode(...salt));
            
            return { hash: hashB64, salt: saltB64, iterations };
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¨®åˆ¥é¸æŠ
            document.querySelectorAll('.user-type-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.user-type-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedUserType = btn.dataset.type;
                    
                    setTimeout(() => {
                        if (selectedUserType === 'ce') {
                            showStep(2);
                        } else {
                            selectedCEId = null;
                            selectedCEName = null;
                            showStep(3);
                            updateStep3Display();
                        }
                    }, 300);
                };
            });

            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
            const continueBtn = document.getElementById('continueToStep3Btn');
            if (continueBtn) {
                continueBtn.onclick = () => {
                    showStep(3);
                    updateStep3Display();
                };
            }

            const backToStep1Btn = document.getElementById('backToStep1Btn');
            if (backToStep1Btn) {
                backToStep1Btn.onclick = () => showStep(1);
            }

            const backToStep2Btn = document.getElementById('backToStep2Btn');
            if (backToStep2Btn) {
                backToStep2Btn.onclick = () => {
                    if (selectedUserType === 'ce') {
                        showStep(2);
                    } else {
                        showStep(1);
                    }
                };
            }

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é–¢é€£
            const newPasswordField = document.getElementById('newPassword');
            if (newPasswordField) {
                newPasswordField.addEventListener('input', updatePasswordStrength);
            }

            const confirmPasswordField = document.getElementById('confirmPassword');
            if (confirmPasswordField) {
                confirmPasswordField.addEventListener('input', checkPasswordMatch);
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
            const setupForm = document.getElementById('setupForm');
            if (setupForm) {
                setupForm.addEventListener('submit', saveSettings);
            }
        }

        // åˆæœŸåŒ–ï¼ˆé˜²å¾¡çš„å®Ÿè£…ï¼‰
        async function init() {
            console.log('ğŸš€ åˆæœŸåŒ–é–‹å§‹');
            
            try {
                // FirebaseåˆæœŸåŒ–å¾…æ©Ÿ
                console.log('â³ FirebaseåˆæœŸåŒ–å¾…æ©Ÿä¸­...');
                if (window.waitForFirebase) {
                    await window.waitForFirebase();
                } else {
                    // fallback: æœ€å¤§5ç§’å¾…æ©Ÿ
                    let attempts = 0;
                    while (!window.auth && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                }
                
                auth = window.auth;
                database = window.database;

                if (!auth || !database) {
                    throw new Error('FirebaseåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†');

                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ç¢ºèª
                const uid = sessionStorage.getItem('targetUID');
                const username = sessionStorage.getItem('currentUsername');
                
                if (!uid || !username) {
                    console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ä¸è¶³:', { uid, username });
                    showMessage('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚', 'error');
                    setTimeout(() => location.href = '../index.html', 2000);
                    return;
                }
                console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ç¢ºèªå®Œäº†');

                // åŒ¿åèªè¨¼
                if (!auth.currentUser) {
                    console.log('ğŸ” åŒ¿åèªè¨¼å®Ÿè¡Œä¸­...');
                    await auth.signInAnonymously();
                    console.log('âœ… åŒ¿åèªè¨¼å®Œäº†');
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
                const dataRoot = window.DATA_ROOT || 'ceSchedulev3';
                console.log('ğŸ“Š ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...');
                
                const userSnap = await database.ref(`${dataRoot}/users/${uid}`).once('value');
                
                if (!userSnap.exists()) {
                    console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
                    setTimeout(() => location.href = '../index.html', 2000);
                    return;
                }

                currentUserData = userSnap.val();
                console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†');

                // UIè¨­å®šï¼ˆé˜²å¾¡çš„ï¼‰
                safeSetText('currentUser', currentUserData.username || 'Unknown');
                safeSetText('usernameDisplay', currentUserData.username || '');
                safeSetValue('displayNameInput', currentUserData.displayName || currentUserData.username || '');
                
                // æ¨©é™è¡¨ç¤º
                const roleBadges = {
                    admin: 'ç®¡ç†è€…',
                    editor: 'ç·¨é›†è€…', 
                    viewer: 'é–²è¦§è€…'
                };
                safeSetText('roleDisplay', roleBadges[currentUserData.role] || 'ä¸æ˜');

                // CEãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
                console.log('ğŸ“‹ CEãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹');
                await loadCEList();
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                console.log('ğŸ¯ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šä¸­');
                setupEventListeners();

                // ç”»é¢è¡¨ç¤º
                const loadingScreen = document.getElementById('loadingScreen');
                const mainContent = document.getElementById('mainContent');
                
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                    console.log('âœ… ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º');
                }
                if (mainContent) {
                    mainContent.style.display = 'block';
                    console.log('âœ… ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º');
                }
                
                // ã‚¹ãƒ†ãƒƒãƒ—1ã‹ã‚‰é–‹å§‹
                console.log('ğŸ¬ ã‚¹ãƒ†ãƒƒãƒ—1è¡¨ç¤ºé–‹å§‹');
                showStep(1);

                console.log('âœ… åˆæœŸåŒ–å®Œå…¨å®Œäº†');

            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error), 'error');
                setTimeout(() => location.href = '../index.html', 2000);
            }
        }

        // è¨­å®šä¿å­˜
        async function saveSettings(event) {
            event.preventDefault();
            
            if (isProcessing) return;

            const displayNameInput = document.getElementById('displayNameInput');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const saveButton = document.getElementById('saveButton');

            const displayName = displayNameInput?.value?.trim() || '';
            const newPassword = newPasswordInput?.value || '';
            const confirmPassword = confirmPasswordInput?.value || '';

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!newPassword || !confirmPassword) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!validatePassword(newPassword).isValid) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¼·åº¦ãŒä¸ååˆ†ã§ã™', 'error');
                return;
            }

            if (!checkPasswordMatch()) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }

            if (selectedUserType === 'ce' && !selectedCEId) {
                showMessage('CEã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // å‡¦ç†é–‹å§‹
            isProcessing = true;
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.innerHTML = '<div class="spinner inline-block mr-2"></div>ä¿å­˜ä¸­...';
            }

            try {
                const uid = sessionStorage.getItem('targetUID');
                const username = sessionStorage.getItem('currentUsername');
                
                if (!uid || !username) {
                    throw new Error('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒç„¡åŠ¹ã§ã™');
                }

                if (!auth.currentUser) {
                    await auth.signInAnonymously();
                }

                const hashedPassword = await hashPasswordPBKDF2(newPassword);

                const dataRoot = window.DATA_ROOT || 'ceSchedulev3';
                const updates = {
                    displayName: displayName || currentUserData.displayName || currentUserData.username,
                    password: hashedPassword,
                    userType: selectedUserType,
                    linkedCEId: selectedCEId,
                    linkedCEName: selectedCEName,
                    setupCompleted: true,
                    hasCompletedSetup: true,
                    needsSetup: false,
                    passwordResetCompleted: false,
                    fromPending: false,
                    isInitialUser: false,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP,
                    setupCompletedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedBy: 'user-setup'
                };

                console.log('ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ä¸­...');
                await database.ref(`${dataRoot}/users/${uid}`).update(updates);

                // å¾…æ©Ÿãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                try {
                    await database.ref(`${dataRoot}/pendingUsers/${username}`).remove();
                } catch (e) { /* å­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡è¦– */ }
                
                try {
                    await database.ref(`${dataRoot}/initialUsers/${uid}`).remove();
                } catch (e) { /* å­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡è¦– */ }

                sessionStorage.setItem('userRole', currentUserData.role || 'viewer');

                showMessage('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ç§»å‹•ã—ã¾ã™ã€‚', 'success');
                
                setTimeout(() => {
                    location.href = './home.html';
                }, 1500);

            } catch (error) {
                console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error), 'error');
            } finally {
                isProcessing = false;
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>è¨­å®šã‚’ä¿å­˜ã—ã¦HOMEã¸';
                }
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function logout() {
            try {
                if (auth && auth.signOut) {
                    await auth.signOut();
                }
            } catch (e) {
                console.warn('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã®ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ï¼‰:', e);
            }
            
            sessionStorage.clear();
            localStorage.clear();
            location.href = '../index.html';
        }

        // å®‰å…¨ãªåˆæœŸåŒ–å®Ÿè¡Œ
        function safeInit() {
            console.log('ğŸ“Œ DOMçŠ¶æ…‹:', document.readyState);
            
            // DOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
            const requiredElements = ['loadingScreen', 'mainContent', 'currentUser', 'step1UserType'];
            const missingElements = requiredElements.filter(id => !document.getElementById(id));
            
            if (missingElements.length > 0) {
                console.error('âŒ å¿…è¦ãªDOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', missingElements);
                alert('ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            console.log('âœ… å¿…è¦ãªDOMè¦ç´ ç¢ºèªå®Œäº†');
            
            // åˆæœŸåŒ–å®Ÿè¡Œ
            setTimeout(init, 100);
        }

        // ç¢ºå®ŸãªåˆæœŸåŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInit);
        } else {
            safeInit();
        }
    </script>
</body>
</html>
